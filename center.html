<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="www.nigelcode.com" />
    <meta name="viewport" content="width=device-width initial-scale=1.0 maximum-scale=1.0 user-scalable=yes" />
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="zyupload/skins/zyupload-1.0.0.min.css " type="text/css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/common.css" />

    <link type="text/css" rel="stylesheet" href="css/demo.css" />
    <link type="text/css" rel="stylesheet" href="css/jquery.mmenu.all.css" />
    <link rel="stylesheet" href="css/style.css">

    <title>后台管理</title>
</head>
<style>
    .wrapItem{
        display: none;
    }
    .wrapItem.active{
        display: block;
    }
    .errcheck{
        color: #FF0000;
        display: none;
    }
    .yzcodeImg{
        cursor: pointer;
    }
    .form-control[readonly]{
        background-color: #ffffff;
        opacity: 1;
    }
    .aboutInfo .label-title{
        font-weight:bold;
        display: inline-block;
        width: 60px;
        text-align: right;
    }
    .aboutInfo .label-content{
        display: inline-block;
        white-space: normal;
        word-break: break-all;
        word-wrap: break-word;
    }
    .aboutInfo .personinfo_content{
        padding: 0 10px;
    }

    .loadingWrap{
        width:100%;
        height:100%;
        position: fixed;
        top:0;
        left:0;
        background: rgba(0,0,0,0.3);
        display: none;
    }
    .loadingWrap img{
        position: absolute;
        width: 100px;
        top:50%;
        left:50%;
        display: block;
        transform: translate(-50%,-50%);
    }

    .allCheck{
        margin:0 0 20px 0;
    }
    .totalPage{
        margin:0 0 0 10px;
    }
    .totalPage,
    .curPage{
        line-height: 30px;
        padding:0 5px;
    }
    .buttonList{
        float: right;
        overflow: hidden;
    }
    .buttonList label{
        position: relative;
        top:-2px;
    }
    .message table tr,
    .friend table tr,
    .flower table tr{
        cursor: pointer;
    }
    .noty_text{
        white-space: normal;
        word-wrap:break-word;
        word-break:break-all;
    }
    .deleteAll,
    .readAll,
    .validateAll{
        float: left;
        margin:0 0 0 10px;
    }
    .pagelist{
        clear: both;
    }

    .text-success{
        color: #3c763d;
    }
    .flower{
        color: #FF0000;
    }

    .item{
        display: none;
    }
    .item.active{
        display: block;
    }
    .content .person_info{
        white-space: normal;
        word-break: break-all;
        word-wrap: break-word;
    }
    .content .page-header{
        font-size: 20px;
    }
    .content .control-label{
        font-size: 20px;
    }

</style>

<body>

<div class="headerWrap"></div>
<div id="page">
    <div class="header">
        <a href="#menu"><span></span></a>
        个人中心
    </div>
    <div class="content">
        <div id="aboutInfo" class="item active">
            <div class="table-responsive">
                <h1 class="page-header">个人信息</h1>
                <table class="table table-striped table-hover">
                    <tbody>
                    <tr>
                        <td>用户名:</td>
                        <td class="username"></td>
                    </tr>
                    <tr>
                        <td>邮箱:</td>
                        <td class="email"></td>
                    </tr>
                    <tr>
                        <td>qq:</td>
                        <td class="qq"></td>
                    </tr>
                    <tr>
                        <td>注册时间:</td>
                        <td class="register_time"></td>
                    </tr>
                    <tr>
                        <td>登录次数:</td>
                        <td class="login_count"></td>
                    </tr>
                    <tr>
                        <td>个人简介:</td>
                        <td>
                            <text class="person_info"></text>
                        </td>
                    </tr>
                    <tr>
                        <td>头像:</td>
                        <td>
                            <img class="person_img" src="" alt="" width="80" height="80">
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!--加载动画-->
            <div class="loadingWrap">
                <img src="img/loading.gif" alt="加载中...">
            </div>
        </div>
        <div id="modifyInfo" class="item">
            <form class="form-horizontal" id="modifyinfoForm">
                <div class="form-group">
                    <label class="control-label">用户名</label>
                    <div>
                        <input type="text" class="form-control" name="username">
                    </div>
                </div>
                <div class="form-group usernameWrap">
                    <div class="errcheck errcheck_repeat">
                        用户名已经存在
                    </div>
                    <div class="errcheck errcheck_empty">
                        用户名不能为空
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label">邮箱</label>
                    <div>
                        <input type="text" class="form-control" name="email">
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label">qq</label>
                    <div>
                        <input type="text" class="form-control" name="qq">
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label">个人简介</label>
                    <div>
                        <textarea class="form-control" name="person_info" cols="30" rows="10"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label">验证码</label>
                    <div>
                        <input type="text" class="form-control" name="yzcode">
                    </div>
                    <div>
                        <img class="yzcodeImg" src="data/yzCode.php" alt="单击刷新验证码" title="单击刷新验证码">
                    </div>
                </div>
                <div class="form-group">
                    <div class="errcheck yzcodeErr" >
                        验证码不正确
                    </div>
                </div>
                <div class="form-group">
                    <div>
                        <button type="submit" class="btn btn-success btn-block">提交</button>
                    </div>
                </div>
            </form>

            <div class="form-group">
                <label class="control-label">个人头像</label>
                <div>
                    <div id="zyupload" class="zyupload"></div>
                </div>
            </div>
        </div>
        <div id="message" class="item">
            <table class="table table-responsive table-hover table-bordered">
                <thead>
                <tr>
                    <td>发送人</td>
                    <td>接收人</td>
                    <td>消息内容</td>
                    <td>日期</td>
                    <td style="text-align: center">状态</td>
                    <td style="text-align: center">操作</td>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
            <div class="buttonList">
                <div class="deleteAll">
                    <input type="checkbox" class="allCheck">
                    <label>删除本页</label>
                </div>
                <div class="readAll">
                    <input type="checkbox" class="allRead">
                    <label>全部已读</label>
                </div>
            </div>
            <!--分页list-->
            <div class="pagelist text-center">
                <nav aria-label="Page navigation" class="Page">

                </nav>
            </div>
        </div>
        <div id="friend" class="item">
            <table class="table table-responsive table-hover table-bordered">
                <thead>
                <tr>
                    <td>添加人</td>
                    <td>验证好友内容</td>
                    <td>日期</td>
                    <td style="text-align: center">状态</td>
                    <td style="text-align: center">操作</td>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
            <div class="buttonList">
                <div class="deleteAll">
                    <input type="checkbox" class="allCheck">
                    <label>删除本页</label>
                </div>
                <div class="readAll">
                    <input type="checkbox" class="allRead">
                    <label>全部验证</label>
                </div>
            </div>
            <!--分页list-->
            <div class="pagelist text-center">
                <nav aria-label="Page navigation" class="Page">

                </nav>
            </div>
        </div>
        <div id="flower" class="item">
            <table class="table table-responsive table-hover table-bordered">
                <thead>
                <tr>
                    <td>送花者</td>
                    <td>送花附加内容</td>
                    <td>日期</td>
                    <td style="text-align: center">花朵数量</td>
                    <td style="text-align: center">操作</td>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
            <div class="buttonList">
                <div class="deleteAll">
                    <input type="checkbox" class="allCheck">
                    <label>删除本页</label>
                </div>
            </div>
            <!--分页list-->
            <div class="pagelist text-center">
                <nav aria-label="Page navigation" class="Page">

                </nav>
            </div>
        </div>
        <div id="photo" class="item">
            个人相册
        </div>
    </div>

    <nav id="menu">
        <ul>
            <li><span>账号管理</span>
                <ul>
                    <li><a href="#aboutInfo" data-index="0">个人信息</a></li>
                    <li><a href="#modifyInfo" data-index="1">修改资料</a></li>
                </ul>
            </li>
            <li><span>其他管理</span>
                <ul>
                    <li><a href="#message" data-index="2">短信查阅</a></li>
                    <li><a href="#friend" data-index="3">好友设置</a></li>
                    <li><a href="#flower" data-index="4">查询花朵</a></li>
                    <li><a href="#photo" data-index="5">个人相册</a></li>
                </ul>
            </li>
        </ul>
    </nav>
</div>

<div class="footerWrap"></div>

<!--登录模态框-->
<div class="modal fade" tabindex="-1" role="dialog" id="loginModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">登录</h4>
            </div>
            <div class="modal-body">
                <div class="wrap login_wrap">
                    <div class="content">
                        <div class="logo"></div>
                        <div class="login_box">
                            <div class="login_form">
                                <div class="login_title">
                                    登录
                                </div>
                                <form action="#" method="post" id="login_form">
                                    <div class="form_text_ipt">
                                        <input name="username" type="text" placeholder="手机号/邮箱">
                                    </div>
                                    <div class="ececk_warning"><span>请输入手机号或邮箱</span></div>
                                    <div class="ececk_warning loginUsername"><span>手机号或邮箱不存在</span></div>
                                    <div class="ececk_warning phoneAndEmailErr"><span>请输入正确格式的手机号或邮箱</span></div>
                                    <div class="form_text_ipt">
                                        <input name="password" type="password" placeholder="密码">
                                    </div>
                                    <div class="ececk_warning"><span>请输入密码</span></div>
                                    <div class="ececk_warning passwordInput"><span>请检查密码是否输入正确</span></div>
                                    <div class="form_check_ipt">
                                        <div class="left check_left">
                                            <label><input name="autoLogin" data-value="0" type="checkbox"> 下次自动登录</label>
                                        </div>
                                        <div class="right check_right">
                                            <a href="#">忘记密码</a>
                                        </div>
                                    </div>
                                    <div class="form_btn">
                                        <button type="submit">登录</button>
                                    </div>
                                    <div class="form_reg_btn">
                                        <span>还没有帐号？</span><a href="#" id="goRegister" data-toggle="modal" data-target="#registerModal">马上注册</a>
                                    </div>
                                </form>
                                <div class="other_login">
                                    <div class="left other_left">
                                        <span>其它登录方式</span>
                                    </div>
                                    <div class="right other_right">
                                        <a href="#">QQ登录</a>
                                        <a href="#">微信登录</a>
                                        <a href="#">微博登录</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!--content -->
                </div>
            </div><!-- /.modal-body -->
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!--注册模态框-->
<div class="modal fade" tabindex="-1" role="dialog" id="registerModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">注册</h4>
            </div>
            <div class="modal-body">
                <div class="wrap login_wrap">
                    <div class="content">

                        <div class="logo"></div>

                        <div class="login_box">

                            <div class="login_form">
                                <div class="login_title">
                                    注册
                                </div>
                                <form action="#" method="post" id="register_form">

                                    <div class="form_text_ipt">
                                        <input name="username" type="text" placeholder="手机号/邮箱">
                                    </div>
                                    <div class="ececk_warning"><span>手机或者邮箱不能为空</span></div>
                                    <div class="ececk_warning phoneAndEmailErr"><span>请输入正确格式的手机号，邮箱</span></div>
                                    <div class="ececk_warning repeatUser"><span>手机号，邮箱已存在</span></div>
                                    <div class="form_text_ipt">
                                        <input name="password" type="password" placeholder="密码">
                                    </div>
                                    <div class="ececk_warning"><span>密码不能为空</span></div>
                                    <div class="form_text_ipt">
                                        <input name="repassword" type="password" placeholder="重复密码">
                                    </div>
                                    <div class="ececk_warning"><span>密码不能为空</span></div>
                                    <div class="ececk_warning confirmPwd"><span>确认密码和原密码不一致</span></div>
                                    <div class="form_text_ipt">
                                        <input name="code" type="text" placeholder="验证码">
                                    </div>
                                    <div class="ececk_warning"><span>验证码不能为空</span></div>

                                    <div class="form_btn">
                                        <button type="submit">注册</button>
                                    </div>
                                    <div class="form_reg_btn">
                                        <span>已有帐号？</span><a href="#" id="goLogin" data-toggle="modal" data-target="#loginModal">马上登录</a>
                                    </div>
                                </form>
                                <div class="other_login">
                                    <div class="left other_left">
                                        <span>其它登录方式</span>
                                    </div>
                                    <div class="right other_right">
                                        <a href="#">QQ登录</a>
                                        <a href="#">微信登录</a>
                                        <a href="#">微博登录</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!--资料修改成功提示模态框-->
<div class="modal fade" tabindex="-1" role="dialog" id="modifySuccessModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">信息修改提示框</h4>
            </div>
            <div class="modal-body">
                个人信息修改成功！
            </div><!-- /.modal-body -->
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!--资料修改失败提示模态框-->
<div class="modal fade" tabindex="-1" role="dialog" id="modifyFailModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">信息修改提示框</h4>
            </div>
            <div class="modal-body">
                非法操作！请重新登录再次修改试试！
            </div><!-- /.modal-body -->
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

</body>

<script src="js/jquery-1.11.3.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/common.js"></script>
<script src="js/login_register.js"></script>
<script src="js/myPage.js"></script>
<script type="text/javascript" src="zyupload/zyupload.basic-1.0.0.min.js"></script>
<script src="js/themes/default.js"></script>
<script src="js/noty.min.js"></script>

<script type="text/javascript" src="js/jQuery.mmenu/jquery.mmenu.all.js"></script>
<script src="js/template.js"></script>


<!--显示消息模板-->
<script id="messageTemp" type="text/html">
    <%for(var i = 0; i < info.length; i++) {%>
    <tr data-id="<%:=info[i].id%>">
        <td><%:=info[i].from_user%></td>
        <td><%:=info[i].to_user%></td>
        <td><%:=info[i].message_content%></td>
        <td><%:=info[i].message_date%></td>
        <td style="text-align: center">
            <%if(info[i].message_state==0){%>
            <span class="glyphicon glyphicon-envelope envelope notWatched" title="未读信息"></span>
            <%}else if(info[i].message_state==1){%>
            <span class="glyphicon glyphicon-envelope envelope" title="已读信息"></span>
            <%}%>
        </td>
        <td style="text-align: center"><label><input title="单击可以删除该条信息" type="checkbox" class="delete"  data-id="<%:=info[i].id%>"></label></td>
    </tr>
    <%}%>
</script>
<!--显示好友模板-->
<script id="friendTemp" type="text/html">
    <%for(var i = 0; i < info.length; i++) {%>
    <tr data-id="<%:=info[i].id%>">
        <td><%:=info[i].from_user%></td>
        <td><%:=info[i].friend_content%></td>
        <td><%:=info[i].friend_date%></td>
        <td style="text-align: center">
            <%if(info[i].friend_state==0){%>
            <span class="glyphicon glyphicon-remove validate notValidate" title="未认证"></span>
            <%}else if(info[i].friend_state==1){%>
            <span class="glyphicon glyphicon-ok validate" title="已认证"></span>
            <%}%>
        </td>
        <td style="text-align: center"><label><input title="单击可以删除该条信息" type="checkbox" class="delete"  data-id="<%:=info[i].id%>"></label></td>
    </tr>
    <%}%>
</script>
<!--显示花朵模板-->
<script id="flowerTemp" type="text/html">
    <%for(var i = 0; i < info.length; i++) {%>
    <tr data-id="<%:=info[i].id%>">
        <td><%:=info[i].from_user%></td>
        <td><%:=info[i].flower_content%></td>
        <td><%:=info[i].flower_date%></td>
        <td style="text-align: center">
            <span class="text-success"><%:=info[i].flower_count%></span>
            <span class="glyphicon glyphicon-apple flower"></span>
        </td>
        <td style="text-align: center"><label><input title="单击可以删除该条信息" type="checkbox" class="delete"  data-id="<%:=info[i].id%>"></label></td>
    </tr>
    <%}%>
</script>

<script type="text/javascript">
    $(function() {
        $('nav#menu').mmenu({
            extensions	: [
                'fx-menu-slide',
                'shadow-page',
                'shadow-panels',
                'listview-large',
                'pagedim-white'
            ],
            iconPanels	: true,
            counters	: true,
            keyboardNavigation : {
                enable	: true,
                enhance	: true
            },
            searchfield : {
                placeholder	: '搜索菜单名'
            },
            navbar : {
                title : ''
            },
            navbars	: [
                {
                    position	: 'top',
                    content		: [ 'searchfield' ]
                }, {
                    position	: 'top',
                    content		: [ 'breadcrumbs', 'close' ]
                }, {
                    position	: 'bottom',
                    content		: [ '<a href="http://mmenu.frebsite.nl/wordpress-plugin" target="_blank">WordPress plugin</a>' ]
                }
            ]
        }, {
            searchfield : {
                clear : true
            }
        });
    });
</script>

<script>
    (function(){
        function notyInfo(data){
            noty({
                text: data,
                layout: "center",
                type: "warning",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '关闭',
                        onClick: function ($noty) {
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function notyInfo2(data,url,flag,that,checkList){
            noty({
                text: data.msg,
                layout: "center",
                type: "warning",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-success btn-xs',
                        text: '确认',
                        onClick: function ($noty) {
                            //删除记录
                            $.ajax({
                                type:"GET",
                                url:url,
                                dataType:"json",
                                success:function (rsp) {
                                    if(rsp.code == 0){  //删除成功
                                        notyInfo("success");
                                        if(flag==1){  //message
                                            showMessage(1);//从第一页开始
                                        }else if(flag==2){  //friend
                                            showFriend(1);//从第一页开始
                                        }else if(flag==3){
                                            showflower(1);
                                        }
                                    }else if(rsp.code == 1){  //重新登录
                                        $("#loginModal").modal('show');
                                    }
                                }
                            });
                            $noty.close();
                        }
                    },
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '取消',
                        onClick: function ($noty) {
                            $(that).prop('checked',false);
                            for(var i=0;i<checkList.length;i++){
                                $(checkList[i]).prop("checked",false);
                            }
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function notyInfo22(data,url,flag,that){
            noty({
                text: data.msg,
                layout: "center",
                type: "warning",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-success btn-xs',
                        text: '确认',
                        onClick: function ($noty) {
                            //删除记录
                            $.ajax({
                                type:"GET",
                                url:url,
                                dataType:"json",
                                success:function (rsp) {
                                    if(rsp.code == 0){  //删除成功
                                        notyInfo("success");
                                        if(flag==1){  //message
                                            showMessage(1);//从第一页开始
                                        }else if(flag==2){  //friend
                                            showFriend(1);//从第一页开始
                                        }else if(flag==3){
                                            showflower(1);
                                        }

                                    }else if(rsp.code == 1){  //重新登录
                                        $("#loginModal").modal('show');
                                    }
                                }
                            });
                            $noty.close();
                        }
                    },
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '取消',
                        onClick: function ($noty) {
                            $(that).prop('checked',false);
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function notyInfo3(data){
            noty({
                text: data,
                layout: "center",
                type: "default",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '关闭',
                        onClick: function ($noty) {
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function notyInfo32(data,that,flag,id){
            noty({
                text: data,
                layout: "center",
                type: "default",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-success btn-xs',
                        text: '通过',
                        onClick: function ($noty) {
                            if(flag){ //如果之前没有通过验证
                                $.getJSON('data/setFriendValidate.php?ids='+id,function (rsp) {
                                    if(rsp.code==0){
                                        //设置成已认证
                                        $(that).find(".validate").removeClass("notValidate glyphicon-remove").addClass("glyphicon-ok"); //!!!

                                    }else if(rsp.code==2){
                                        //登录时间过期，请重新登录
                                        $("#loginModal").modal('show');
                                    }
                                });
                            }
                            $noty.close();
                        }
                    },
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '关闭',
                        onClick: function ($noty) {
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function notyInfo4(data,url,flag,that){
            noty({
                text: data.msg,
                layout: "center",
                type: "warning",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-success btn-xs',
                        text: '确认',
                        onClick: function ($noty) {
                            //删除记录
                            $.ajax({
                                type:"GET",
                                url:url,
                                dataType:"json",
                                success:function (rsp) {
                                    if(rsp.code == 0){
                                        if(flag==1){ //1-message
                                            $(".envelope").removeClass("notWatched");
                                            //同时设置头部上的信息数量
                                            $(".envelope_count").text(0).css({display:"none"});
                                        }else if(flag==2){ //2-friend
                                            $(".validate").removeClass("notValidate glyphicon-remove").addClass("glyphicon-ok");
                                        }

                                    }else if(rsp.code == 2){  //重新登录
                                        $("#loginModal").modal('show');
                                    }
                                }
                            });
                            $noty.close();
                        }
                    },
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '取消',
                        onClick: function ($noty) {
                            $(that).prop("checked",false);
                            $noty.close();
                        }
                    }
                ]
            });
        }

        function clearForm($Form) {
            $Form.find("input").val("");
            $Form.find("textarea").val("");
        }
        //1-代表当前active,分别对应个人信息，修改资料，短信查询，好友设置，查询花朵，个人相册
        var menuList = [0,0,0,0,0,0];
        var messageArr = [], //用来保存消息数组
            friendArr = [],//用来保存好友数组
            flowerArr = [],//用来保存花朵的数组
            $friend = $("#friend"),
            $flower = $("#flower"),
            $message = $("#message"),
            $aboutInfo = $("#aboutInfo");
        //从本地存储读取menuList

        //个人中心，首先需要登录，用户表，增加1 注册时间字段，用户2 客户端所在ip字段，3 登录次数字段，uinique,active等字段
        //其中unique用来安全防护，active用来激活邮箱用
        //另外增加可选的邮箱，qq，头像，个人简介字段
        function getPersonInfo(username){
            //请求个人信息接口
            $.getJSON('data/getUserInfo.php?username='+username,function (data) {
                if(data.code == 0){// 请求信息成功
                    $(".loadingWrap").hide();
                    var rsp = data.info;
                    var head_imgSrc = "img/headPhoto/";
                    if(rsp[0].head_img){
                        head_imgSrc += rsp[0].head_img;
                    }
                    rsp[0].username?$aboutInfo.find('.username').eq(0).text(rsp[0].username):"";
                    rsp[0].email?$aboutInfo.find('.email').eq(0).text(rsp[0].email):"";
                    rsp[0].qq?$aboutInfo.find('.qq').eq(0).text(rsp[0].qq):"";

                    rsp[0].time?$aboutInfo.find('.register_time').eq(0).text(rsp[0].time):"";
                    rsp[0].login_count?$aboutInfo.find('.login_count').eq(0).text(rsp[0].login_count):"";
                    rsp[0].person_info?$aboutInfo.find('.person_info').text(rsp[0].person_info):"";

                    //显示用户头像
                    rsp[0].head_img?$aboutInfo.find('.person_img').eq(0).attr('src',head_imgSrc):
                        $aboutInfo.find('.person_img').eq(0).attr('src','');
                }
            });
        }
        function validateLogin() {
            var userInfo;
            if(window.localStorage.getItem('userInfo')){
                userInfo = JSON.parse(window.localStorage.getItem('userInfo'));
            }
            if( userInfo && userInfo.username){
                $('.headerWrap').find('.username_head').text(userInfo.username);
                $('.headerWrap').find('.login').hide();
                $('.headerWrap').find('.register').hide();
                $('.headerWrap').find(".loginOut").removeClass('hidden');

                //请求信息接口，获取未查看信息条数
                $.get("data/getMessageCount.php?username="+userInfo.username,function (count) {
                    if(count>0){
                        $(".envelope_count").text(count).css({display:"inline-block"});
                    }
                });
                if(localStorage.getItem("menuList")){
                    menuList = JSON.parse(localStorage.getItem("menuList"));
                    $(".content .item").removeClass("active");
                    for(var i=0;i<menuList.length;i++){
                        if(menuList[i] == 1){
                            switch (i){
                                case 0://个人信息
                                    getPersonInfo(userInfo.username);
                                    break;
                                case 2://短信查询
                                    showMessage(1);
                                    break;
                                case 3://好友查询
                                    showFriend(1);
                                    break;
                                case 4://花朵查询
                                    showflower(1);
                                    break;
                                case 5://个人相册
                                    break;
                            }
                            $(".content .item").eq(i).addClass('active');
                        }
                    }
                }else{
                    menuList = [1,0,0,0,0,0];
                    localStorage.setItem("menuList",JSON.stringify(menuList));
                    getPersonInfo(userInfo.username);
                }

                //消息增加点击事件，跳转到信息查看页面
                $('.envelope_wrap').click(function () {
                    var menuList = [0,0,1,0,0,0];
                    localStorage.setItem("menuList",JSON.stringify(menuList));
                    location.href = 'center.html';
                });

            }else{
                //请登录后操作
                //使用unique防止伪登录
                //注册时生成唯一unique,登录时，将unique存在cookie或者session中
                //登录需要对密码进行加密-暂时不做
                //未激活不能登录，激活过的用户，active设置为空，邮箱激活或者手机验证码激活--暂时不做

                //做资料修改的时候，需要进行敏感验证，必须比对cookie和数据库的唯一标识符，防止伪造登录cookie
                //如果做到更安全，在敏感操作后，可以重新生成唯一标识符，并且写入数据库写入cookie
                $("#loginModal").modal('show');
            }
        }
        function validateLogin2() {
            var userInfo;
            if(window.localStorage.getItem('userInfo')){
                userInfo = JSON.parse(window.localStorage.getItem('userInfo'));
            }
            if( userInfo && userInfo.username){
                $('.headerWrap').find('.username_head').text(userInfo.username);
                $('.headerWrap').find('.login').hide();
                $('.headerWrap').find('.register').hide();
                $('.headerWrap').find(".loginOut").removeClass('hidden');

                //请求信息接口，获取未查看信息条数
                $.get("data/getMessageCount.php?username="+userInfo.username,function (count) {
                    if(count>0){
                        $(".envelope_count").text(count).css({display:"inline-block"});
                    }
                });

                return true;

            }else{
                $("#loginModal").modal('show');
                return false;
            }
        }
//        加载头部，验证登陆
        $('.headerWrap').load('common.inc/header.html',function () {
            validateLogin();
        });
        $('.footerWrap').load('common.inc/footer.html');

        //单击其他管理下的相应菜单，显示对应内容
//显示消息
        function showMessage(curPage) {
            $.ajax({
                type:"GET",
                url:"data/getMessage.php?page="+curPage,
                dataType:"JSON",
                async:false,
                success:function (rsp) {
                    if(rsp.code==0){
                        var totalPages = rsp.pagesCount;
                        //显示消息数据
                        //对消息内容长度进行处理
                        var info = rsp.info;
                        for(var i=0;i<info.length;i++){
                            messageArr[i] = info[i].message_content;//i-对应第i行消息
                            if(info[i].message_content.length>20){
                                info[i].message_content = info[i].message_content.substr(0,20)+"...";
                            }
                        }
                        var messageTemp = document.getElementById("messageTemp").innerHTML,
                            html = template(messageTemp,{info:info});
                        $message.find("table>tbody").html(html);
                        //生成分页list
                        $message.find(".pagelist .Page").html(pages(totalPages,curPage));
                    }else if(rsp.code==2){
                        //重新登录
                        $("#loginModal").modal('show');
                    }else if(rsp.code==-1){
                        $message.find("table>tbody").html("");
                    }
                }
            });
        }
//单击消息列表行，显示详细消息内容，并且设置成已查看
        $message.on('click','tr',function (e) {
            var index = $(this).index();
            var message_content = messageArr[index];
            notyInfo3(message_content);
            var id = $(this).attr('data-id');
            //设置成已读,需要加一个批量设置已读
            //如果已经是已读状态，就不需要设置了
            var flag = $(this).find(".envelope").hasClass("notWatched");
            var that = this;
            if(flag){
                $.getJSON('data/setMessageRead.php?ids='+id,function (rsp) {
                    if(rsp.code==0){
                        //不需要通知已经设置成已读，只要将消息标示
                        $(that).find(".envelope").removeClass("notWatched");
                        //同时设置头部上的信息数量
                        if(rsp.count>0){
                            $(".envelope_count").text(rsp.count).css({display:"inline-block"});
                        }else{
                            $(".envelope_count").css({display:"none"});
                        }

                    }else if(rsp.code==2){
                        //登录时间过期，请重新登录
                        $("#loginModal").modal('show');
                    }
                });
            }
        });
//显示好友信息
        function showFriend(curPage) {
            $.ajax({
                type:"GET",
                url:"data/getFriend.php?page="+curPage,
                dataType:"JSON",
                async:false,
                success:function (rsp) {
                    if(rsp.code==0){
                        var totalPages = rsp.pagesCount;
                        //对消息内容长度进行处理
                        var info = rsp.info;
                        for(var i=0;i<info.length;i++){
                            friendArr[i] = info[i].friend_content;//i-对应第i行消息
                            if(info[i].friend_content.length>20){
                                info[i].friend_content = info[i].friend_content.substr(0,20)+"...";
                            }
                        }
                        //显示消息数据
                        var friendTemp = document.getElementById("friendTemp").innerHTML,
                            html = template(friendTemp,{info:info});
                        $friend.find("table>tbody").html(html);

                        //生成分页list
                        $friend.find(".pagelist .Page").html(pages(totalPages,curPage));
                    }else if(rsp.code==2){
                        //重新登录
                        $("#loginModal").modal('show');
                    }else if(rsp.code==-1){
                        $friend.find("table>tbody").html("");
                    }
                }
            });
        }
//单击好友行，显示详细好友消息内容，并且设置成已查看
        $friend.on('click','tr',function (e) {
            var index = $(this).index();
            var friend_content = friendArr[index];
            //添加是否确认验证按钮

            var id = $(this).attr('data-id');
            //设置成已验证,需要加一个批量设置已读
            //如果已经是已读状态，就不需要设置了
            var flag = $(this).find(".validate").hasClass("notValidate");
            var that = this;
            notyInfo32(friend_content,that,flag,id);

        });
        //显示花朵信息
        function showflower(curPage) {
            $.ajax({
                type:"GET",
                url:"data/getFlower.php?page="+curPage,
                dataType:"JSON",
                async:false,
                success:function (rsp) {
                    if(rsp.code==0){
                        var totalPages = rsp.pagesCount;
                        //对消息内容长度进行处理
                        var info = rsp.info;
                        for(var i=0;i<info.length;i++){
                            flowerArr[i] = info[i].flower_content;//i-对应第i行消息
                            if(info[i].flower_content.length>20){
                                info[i].flower_content = info[i].flower_content.substr(0,20)+"...";
                            }
                        }
                        //显示消息数据
                        var flowerTemp = document.getElementById("flowerTemp").innerHTML,
                            html = template(flowerTemp,{info:info});
                        $flower.find("table>tbody").html(html);
                        //生成分页list
                        $flower.find(".pagelist .Page").html(pages(totalPages,curPage));
                    }else if(rsp.code==2){
                        //重新登录
                        $("#loginModal").modal('show');
                    }else if(rsp.code==-1){
                        $flower.find("table>tbody").html("");
                    }
                }
            });
        }
//单击花朵行，显示详细消息内容
        $flower.on('click','tr',function (e) {
            var index = $(this).index();
            var flower_content = flowerArr[index];
            //添加是否确认验证按钮
            notyInfo(flower_content);
        });

        //其他管理，子菜单
        $("#menu").on('click','a',function (e) {
            e.preventDefault();
            var $wrapId = $($(this).attr('href')),
                wrapId = $(this).attr('href');
            $(".content .item").removeClass('active');
            $wrapId.addClass('active');
            var index = $(this).attr('data-index');
            menuList = [0,0,0,0,0,0];
            menuList[index] = 1;
            //将menuList保存到本地存储
            localStorage.setItem("menuList",JSON.stringify(menuList));
            switch ( wrapId ){
                case "#aboutInfo":
                    //个人信息
                    //单击个人信息，请求个人信息接口,添加加载动画,如果之前关闭了浏览器，那么需要重新登录下
                    //否则修改的时候会有问题
                    if(window.localStorage.getItem('userInfo')){
                        userInfo = JSON.parse(window.localStorage.getItem('userInfo'));
                    }
                    if( userInfo &&  userInfo.username){
                        getPersonInfo(userInfo.username);
                    }else{
                        $("#loginModal").modal('show');
                    }
                    break;
                case "#modifyInfo":
                    //修改信息
                    break;
                case "#message":
                    //展示信息
                    showMessage(1);
                    break;
                case "#friend":
                    showFriend(1);
                    break;
                case "#flower":
                    showflower(1);
                    break;
                case "#photo":
                    break;
            }

        });
//显示相关操作
//使用flag来判断是显示消息还是显示好友，1-消息，2-好友，3-花朵
        function initAction($wrap,flag){
            var $pagelist = $wrap.find(".pagelist").eq(0);
            $pagelist.on('click','li>a:not(.prev,.next)',function (e) {
                e.preventDefault();
                var curPage = parseInt($(this).attr('data-page'));
                if(flag==1){
                    showMessage(curPage);
                }else if(flag==2){
                    showFriend(curPage);
                }
            });
            //上一页，下一页
            $pagelist.on('click','.prev',function (e) {
                e.preventDefault();
                var curPage = parseInt($pagelist.find(".nowPage.active>a").attr("data-page"));
                curPage--;
                if(flag==1){
                    if(curPage>0){
                        showMessage(curPage);
                    }else{
                        showMessage(1);
                    }
                }else if(flag==2){
                    if(curPage>0){
                        showFriend(curPage);
                    }else{
                        showFriend(1);
                    }
                }

            });
            $pagelist.on('click','.next',function (e) {
                e.preventDefault();
                //获取当前页curPage
                var totalPages = $pagelist.find(".totalPage").attr('data-total');
                var curPage = parseInt($pagelist.find(".nowPage.active>a").attr("data-page"));
                curPage++;
                if(flag==1){
                    if(curPage<=totalPages){
                        showMessage(curPage);
                    }else{
                        //获取中页数
                        showMessage(totalPages);
                    }
                }else if(flag==2){
                    if(curPage<=totalPages){
                        showFriend(curPage);
                    }else{
                        //获取中页数
                        showFriend(totalPages);
                    }
                }
            });

            //单击操作复选框,删除单条记录，涉及到修改数据，必须验证登陆有效性！！！
            $wrap.on('click','input.delete',function (e) {
                e.stopPropagation(); //阻止冒泡
                //检测是否登录以及登录有效性
                var loginFlag = validateLogin2();
                var that = this;
                if(loginFlag){
                    if($(this).is(":checked")){
                        //删除记录
                        var id = $(this).attr("data-id");
                        var data = {
                            ids:id,
                            msg:"确认删除该条记录"
                        };
                        if(flag==1){
                            var url = "data/deleteMessage.php?ids="+data.ids;
                            notyInfo22(data,url,flag,that);
                        }else if(flag==2){
                            var url = "data/deleteFriend.php?ids="+data.ids;
                            notyInfo22(data,url,flag,that);
                        }else if(flag==3){
                            var url = "data/deleteFlower.php?ids="+data.ids;
                            notyInfo22(data,url,flag,that);
                        }
                    }
                }
            });
            //批量删除
            $wrap.on('click','input.allCheck',function () {
                var checkList = $wrap.find("input.delete");
                var that = this;
                if($(this).is(":checked")){
                    //删除记录
                    var id = "";
                    for(var i=0;i<checkList.length-1;i++){
                        $(checkList[i]).prop("checked",true);
                        id +=  $(checkList[i]).attr('data-id')+",";
                    }
                    $(checkList[i]).prop("checked",true);
                    id +=  $(checkList[i]).attr('data-id');
                    var data = {
                        ids:id,
                        msg:"确认删除该条记录"
                    };
                    if(flag==1){
                        var url = "data/deleteMessage.php?ids="+data.ids;
                        notyInfo2(data,url,flag,that,checkList);
                    }else if(flag==2){
                        var url = "data/deleteFriend.php?ids="+data.ids;
                        notyInfo2(data,url,flag,that,checkList);
                    }else if(flag==3){
                        var url = "data/deleteFlower.php?ids="+data.ids;
                        notyInfo2(data,url,flag,that,checkList);
                    }
                }else{
                    for(var i=0;i<checkList.length;i++){
                        $(checkList[i]).prop("checked",false);
                    }
                }
            });
            //全部标记已读readAll,//全部标记验证好友
            $wrap.on('click','input.allRead',function () {
                var that = this;
                var checkList = $wrap.find("input.delete");
                if($(this).is(":checked")){
                    //删除记录
                    var id = "";
                    for(var i=0;i<checkList.length-1;i++){
                        id +=  $(checkList[i]).attr('data-id')+",";
                    }
                    id +=  $(checkList[i]).attr('data-id');
                    if(flag==1){ //1-message--全部标记已读
                        var count = parseInt($(".envelope_count").text());
                        if(count>0 ){  //前提是还有未读的消息
                            var data = {
                                ids:id,
                                msg:"确认标记全读"
                            };
                            var url = "data/setMessageRead.php?ids="+data.ids;
                            notyInfo4(data,url,flag,that);
                        }
                    }else if(flag==2){ //2-friend--全部标记验证
                        var data = {
                            ids:id,
                            msg:"确认全部通过验证"
                        };
                        var url = "data/setFriendValidate.php?ids="+data.ids;
                        notyInfo4(data,url,flag,that);
                    }


                }else{
                    for(var i=0;i<checkList.length;i++){
                        $(checkList[i]).prop("checked",false);
                    }
                }
            });

        }
//显示消息相关操作
        initAction($message,1);
//显示好友相关操作
        initAction($friend,2);
//显示花朵相关操作
        initAction($flower,3);
        /*--------------------------------修改资料---------------------------------------*/
        //2 增加验证码验证
        var $modifyinfoForm = $('#modifyinfoForm');
        $modifyinfoForm.find(".yzcodeImg").click(function () {
            this.src= "data/yzCode.php";
        });
        $modifyinfoForm.on('blur keyup','input[name=yzcode]',function () {
            var yzcode = $(this).val();
            //验证用户输入的验证码是否和服务器端生成的一样
            if(yzcode != getCookie('yzcode')){
                $(".yzcodeErr").show();
                //提交禁用
                $("#modifyinfoForm").find("button[type=submit]").attr('disabled',true);
                return;
            }else{
                $(".yzcodeErr").hide();
                $("#modifyinfoForm").find("button[type=submit]").attr('disabled',false);
            }
        });
        $modifyinfoForm.find("input[name=yzcode]").focus(function () {
            $(".yzcodeErr").hide();
        });

        //提交资料之前，对名字进行处理，名字不能重名
        $modifyinfoForm.find("input[name=username]").on('blur',function () {
            var username = $(this).val();
            //1 提前将用户名读取出来，放在一个数组中，每次输入的时候对比username!-细节1-暂时不处理
            $.getJSON('data/isRepeatUsername.php?username='+username,function (rsp) {
                if(rsp.code==0){//用户已存在
                    $(".usernameWrap .errcheck_repeat").show();
                    //提交禁用
                    $modifyinfoForm.find("button[type=submit]").attr('disabled',true);
                }else{
                    $(".usernameWrap .errcheck_repeat").hide();
                    $modifyinfoForm.find("button[type=submit]").attr('disabled',false);
                }
            });
        });
        $modifyinfoForm.find("input[name=username]").on('focus',function () {
            $(".usernameWrap .errcheck").hide();
        });


        function notyInfoSuccess() {
            noty({
                text: "修改成功",
                layout: "center",
                type: "success",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '关闭',
                        onClick: function ($noty) {
                            //清空修改信息表单
                            clearForm($modifyinfoForm);
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function notyInfoFail() {
            noty({
                text: "非法操作",
                layout: "center",
                type: "warning",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '关闭',
                        onClick: function ($noty) {
                            //清空修改信息表单
                            clearForm($modifyinfoForm);
                            $noty.close();
                        }
                    }
                ]
            });
        }

        //提交修改的资料,提交先查看cookie中是否uniq,没有重新登录，提交修改资料失败情况处理
        $modifyinfoForm.on('submit',function (e) {
            e.preventDefault();
            //验证码不能为空
            var yzcode = $modifyinfoForm.find("input[name=yzcode]").val();
            if(yzcode != getCookie('yzcode') || yzcode==''){
                //提交禁用
                $modifyinfoForm.find(".yzcodeErr").eq(0).show();
                $modifyinfoForm.find("button[type=submit]").attr('disabled',true);
                return;
            }else{
                $modifyinfoForm.find(".yzcodeErr").eq(0).hide();
                $modifyinfoForm.find("button[type=submit]").attr('disabled',false);
            }

            var data = $(this).serializeArray();
            var username = data[0].value,
                email = data[1].value,
                qq = data[2].value,
                personInfo = data[3].value;

            //用户名不能为空
            if(username==''){
                $modifyinfoForm.find(".usernameWrap .errcheck_empty").show();
                $modifyinfoForm.find("button[type=submit]").attr('disabled',true);
                return;
            }else{
                $(".errcheck_empty").hide();
            }
            $.ajax({
                type:"POST",
                url:"data/modifyInfo.php",
                dataType:"JSON",
                data:{
                    'username':username,
                    'email':email,
                    'qq':qq,
                    'personInfo':personInfo
                },
                success:function (rsp) {
                    if(rsp.code == 0){  //修改资料成功
                        var userInfo = {
                            username:username,
                            isAutoLogin:1
                        };
                        window.localStorage.setItem('userInfo',JSON.stringify(userInfo)); //1-代表自动登陆
                        notyInfoSuccess();
                    }else if(rsp.code==-1){  //非法操作
                        notyInfoFail();
                    }else if(rsp.code == 1){  //重新登录，原因是关闭过浏览器，使用session保存的用户名和uniq已经失效
                        $("#loginModal").modal('show');
                    }
                }
            });
        });

        //每次刷新,从本地存储中取上次所在的导航页，而不是每次都是个人信息页
    })();

</script>

<!--------------------------------上传头像--------------------------------------->
<script type="text/javascript">
    $(function(){
        // 初始化插件
        $("#zyupload").zyUpload({
            width            :   "100%",                 // 宽度
            height           :   "400px",                 // 宽度
            itemWidth        :   "100px",                 // 文件项的宽度
            itemHeight       :   "80px",                 // 文件项的高度
            url              :   "data/up.php",              // 上传文件的路径
            fileType         :   ["jpg","png","jpeg","gif","bmp"],// 上传文件的类型
            fileSize         :   5120000,                // 头像的大小5MB
            multiple         :   false,                    // 是否可以多个文件上传
            dragDrop         :   false,                   // 是否可以拖动上传文件
            tailor           :   false,                   // 是否可以裁剪图片
            del              :   true,                    // 是否可以删除文件
            finishDel        :   false,  				  // 是否在上传文件完成后删除预览
            /* 外部获得的回调接口 */
            onSuccess: function(file, rsp){          // 文件上传成功的回调方法
                var rsp = JSON.parse(rsp);
                if( rsp.code == 0 ){
                    $("#uploadInf").html("<p class='text-success'>"+rsp.msg+"</p>");
                }else if( rsp.code == 1 ){
                    $("#uploadInf").html("<p class='text-success'>"+rsp.msg+"</p>");
                }else if( rsp.code == -1 ){
                    $("#uploadInf").html("<p class='text-success'>"+rsp.msg+"</p>");
                }
            },
            onFailure: function(file, response){          // 文件上传失败的回调方法
                $("#uploadInf").html("<p class='text-danger'>上传失败</p>");
            }
        });

    });

</script>
</html>