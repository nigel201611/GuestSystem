<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link href="css/froala_editor.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="css/froala_page.css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/common.css" />
    <title>多用户留言系统-首页</title>

</head>
<style>
    .confirmPwd{
        display: none;
    }
    .newMembership .username{
        font-size: 24px;
        white-space: normal;
        word-wrap: break-word;
        word-break: break-all;
    }
    .tipList{
        padding: 40px 0 0 40px;
    }
    .commentCount,
    .readCount,
    .time{
        color: #dddddd;
    }
    .tipList .title{
        font-size: 14px;
        font-weight:bolder;
    }
    .tipList li{
        cursor: pointer;
    }
</style>

<body>

    <div class="headerWrap"></div>

    <div class="container">
        <div class="row">
            <div class="col-md-3 col-sm-6">
                <div class="newMembership">
                    <!--#include file="template/newMember2.html" -->
                </div>
                <div class="newImgList"></div>
            </div>
            <div class="col-md-8 col-sm-6">
                <div class="issuePost">
                    <button class="btn btn-default issueTz pull-right">
                        <span class="glyphicon glyphicon-share-alt"></span>
                        发布帖子
                    </button>
                </div>
                <div class="tipList">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>

                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>

                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>

                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <a href="#" class="title">标题-我的是开始思考思考思考开始快速打开</a>
                            <span class="pull-right">
                                <span class="readCount">阅读次数(100)</span>
                                <span class="commentCount">评论次数(100)</span>
                                <span class="time"> 2017-7-20</span>
                            </span>
                        </li>
                    </ul>
                    <!--分页list-->
                    <div class="pagelist text-center">
                        <nav aria-label="Page navigation" class="Page">

                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footerWrap"></div>

    <!--#include file="template/modalTemplate.html"-->

    <!--发布帖子模态框-->
    <div class="modal fade" tabindex="-1" role="dialog" id="issueTzModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">发布帖子</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" id="issuePostForm" >
                        <div class="form-group">
                            <label class="col-sm-2 control-label">帖子标题</label>
                            <div class="col-sm-6">
                                <input type="text" name="article_title" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-2 col-sm-6 errcheck tzTitleErr" >
                                帖子标题不能为空
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">帖子内容</label>
                            <div class="col-sm-10">
                                <div id="edit"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">验证码</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" name="yzcode">
                            </div>
                            <div class="col-sm-2">
                                <img class="yzcodeImg" src="data/yzCode.php" alt="单击刷新验证码" title="单击刷新验证码">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-2 col-sm-6 errcheck yzcodeErr" >
                                验证码不正确
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-2 col-sm-6">
                                <button type="submit" class="btn btn-default">发布</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
</body>

<script src="js/jquery-1.11.3.js"></script>
<script src="js/froala_editor/froala_editor.min.js"></script>
<!--[if lt IE 9]>
<script src="../js/froala_editor/froala_editor_ie8.min.js"></script>
<![endif]-->
<script src="js/froala_editor/plugins/tables.min.js"></script>
<script src="js/froala_editor/plugins/lists.min.js"></script>
<script src="js/froala_editor/plugins/colors.min.js"></script>
<script src="js/froala_editor/plugins/media_manager.min.js"></script>
<script src="js/froala_editor/plugins/font_family.min.js"></script>
<script src="js/froala_editor/plugins/font_size.min.js"></script>
<script src="js/froala_editor/plugins/block_styles.min.js"></script>

<script src="js/bootstrap.min.js"></script>
<script src="js/noty.min.js"></script>
<script src="js/template.js"></script>
<script src="js/common.js"></script>
<script src="js/login_register.js"></script>

<script type="text/html" id="tzTemp">
    <%for(var i = 0; i < info.length; i++) {%>
    <li class="list-group-item">
        <a href="#" class="title" data-title="<%:=info[i].pub_title%>"><%:=info[i].pub_title%></a>
        <span class="pull-right">
                                <span class="readCount">阅读次数(<%:=info[i].pub_readCount%>)</span>
                                <span class="commentCount">评论次数(<%:=info[i].pub_commentCount%>)</span>
                                <span class="time"> <%:=info[i].pub_date%></span>
                            </span>
    </li>
    <%}%>
</script>

<script>
    (function () {
        function notyInfo(data){
            noty({
                text: data,
                layout: "center",
                type: "warning",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '关闭',
                        onClick: function ($noty) {
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function validateLogin2() {
            var userInfo;
            if(window.localStorage.getItem('userInfo')){
                userInfo = JSON.parse(window.localStorage.getItem('userInfo'));
            }
            if( userInfo && userInfo.username){
                $('.headerWrap').find('.username').text(userInfo.username);
                $('.headerWrap').find('.login').hide();
                $('.headerWrap').find('.register').hide();
                $('.headerWrap').find(".loginOut").removeClass('hidden');

                //请求信息接口，获取未查看信息条数
                $.get("data/getMessageCount.php?username="+userInfo.username,function (count) {
                    if(count>0){
                        $(".envelope_count").text(count).css({display:"inline-block"});
                    }
                });

                return true;

            }else{
                $("#loginModal").modal('show');
                return false;
            }
        }

        $('.headerWrap').load('common.inc/header.html',function () {
            var userInfo;
            if(window.localStorage.getItem('userInfo')){
                userInfo = JSON.parse(window.localStorage.getItem('userInfo'));
            }
            if(userInfo.username){
                $('.headerWrap').find('.username').text(userInfo.username);
                $('.headerWrap').find('.login').hide();
                $('.headerWrap').find('.register').hide();
                $('.headerWrap').find(".loginOut").removeClass('hidden');
            }
            //消息增加点击事件，跳转到信息查看页面
            $('.envelope_wrap').click(function () {
                var menuList = [0,0,1,0,0,0];
                localStorage.setItem("menuList",JSON.stringify(menuList));
                location.href = 'person_center.html';
            });
        });
        $('.footerWrap').load('common.inc/footer.html');
//        帖子编辑器初始化
        var $issuePostForm = $("#issuePostForm"),
            $issueTzModal = $("#issueTzModal");
        $('#edit').editable({inlineMode: false, alwaysBlank: true});
        //隐藏模态框时，清空帖子模态框内容
        $issueTzModal.on('hide.bs.modal',function () {
            $issueTzModal.find("input[name=article_title]").val("");
            $issueTzModal.find(".froala-element.f-basic").html("");

            $issueTzModal.find(".yzcodeImg").attr('src',"data/yzCode.php");
        });
        $(".issueTz").click(function () {
            //发布帖子前验证登陆有效性
           var loginFlag =  validateLogin2();
           if(loginFlag){
               $issueTzModal.modal('show');
           }
        });
        //处理图片在某些浏览器偶然性概率打开慢的问题
        $issueTzModal.on('click','button[data-cmd=insertImage]',function () {
            $('.froala-image-popup').find('input[type=file]').attr("accept",
                "image/jpg,image/jpeg,image/png,image/tif,image/gif,image/bmp,image/jpeg");
        });
        $issuePostForm.on('blur keyup','input[name=yzcode]',function () {
            var yzcode = $(this).val();
            //验证用户输入的验证码是否和服务器端生成的一样
            if(yzcode != getCookie('yzcode')){
                $(".yzcodeErr").show();
                //提交禁用
                $issuePostForm.find("button[type=submit]").attr('disabled',true);
                return;
            }else{
                $(".yzcodeErr").hide();
                $issuePostForm.find("button[type=submit]").attr('disabled',false);
            }
        });
        $issuePostForm.find("input[name=yzcode]").focus(function () {
            $(".yzcodeErr").hide();
        });
        $issuePostForm.find(".yzcodeImg").click(function () {
            this.src= "data/yzCode.php";
        });
        //发布帖子
        $issuePostForm.submit(function (e) {
            e.preventDefault();
            var data = $(this).serializeArray();
            var tzTitle = data[0].value,
                yzcode = data[1].value;
            //验证码验证
            if(yzcode != getCookie('yzcode') || yzcode==''){
                $(".yzcodeErr").show();
                //提交禁用
                $issuePostForm.find("button[type=submit]").attr('disabled',true);
                return;
            }else{
                $(".yzcodeErr").hide();
                //提交禁用
                $issuePostForm.find("button[type=submit]").attr('disabled',false);
            }
            //帖子标题不能为空
            if(tzTitle==''){
                $(".tzTitleErr").show();
                //提交禁用
                $issuePostForm.find("button[type=submit]").attr('disabled',true);
                return;
            }else{
                $(".tzTitleErr").hide();
                //提交禁用
                $issuePostForm.find("button[type=submit]").attr('disabled',false);
            }
            var tzContent = $('.froala-element.f-basic').html();
            var data = {
                tzTitle:tzTitle,
                tzContent:tzContent
            };

            //请求接口，发布
          $.ajax({
              type:'POST',
              url:'data/issuePost.php',
              dataType:'JSON',
              data:data,
              success:function (rsp) {
                  if(rsp.code==0){
                      notyInfo("发布成功");
                      $issueTzModal.modal('hide');
                  }else if(rsp.code==2){
                      //重新登录
                      $("#loginModal").modal('show');
                  }else if(rsp.code==-1){
                      notyInfo("发布失败");
                  }
              }
          });
        });
        //显示帖子
        //分页相关函数
        function mlist(list,totalPages,curPage) {
            if(totalPages>=5){  //总页数大于等于5的情况下
                var num = 2;//一个中间分隔数
                //1,2,
                if(curPage>num && curPage<=(totalPages-num) ){ //正常情况下
                    for(var i=num;i>0;i--){
                        var n = curPage-i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                    list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                    //3,4
                    for(var i=1;i<=num;i++){
                        var n = curPage+i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                }else if(curPage<=num){//如果当前页小于$num，也要同时显示5个
                    for(var i=curPage-1;i>0;i--){
                        var n = curPage-i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                    list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                    //3,4
                    for(var i=1;i<=num+(num-curPage+1);i++){//!!! 2-3,1-4
                        var n = curPage+i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                }else if( curPage>totalPages-num ){ //如果当前页大于于$totoalPage，也要同时显示5个
                    for(var i=num+(curPage-totalPages+num);i>0;i--){ //16,17,18||16,17,18,19--19-3,20-4
                        var n = curPage-i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                    list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                    //3,4
                    for(var i=(curPage-totalPages+num);i<num;i++){ //19-1,20-0
                        var n = curPage+i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                }
            }else{ //总页数小于5时
                for(var i=1;i<curPage;i++){
                    list += `<li><a href="#" data-page="${i}">${i}</a></li>`;
                }
                list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                for(var i=curPage+1;i<=totalPages;i++){
                    list += `<li><a href="#" data-page="${i}">${i}</a></li>`;
                }

            }
            return list;
        }
        function flist(list, totalPages,curPage) {
            list += `<ul class="pagination">
                             <span class="totalPage" data-total="${totalPages}">共${totalPages}页</span>
                             <span class="curPage">当前第${curPage}页</span>
                             <li>
                             <a href="#" aria-label="first" data-page="1">
                             <span aria-hidden="true">首页</span>
                             </a>
                             </li>
                           <li>
                             <a href="#" aria-label="Previous" class="prev">
                             <span aria-hidden="true">上一页</span>
                             </a>`;
            return list;
        }
        function llist(list,totalPages){
            list += `<li>
                             <a href="#" aria-label="Next" class="next">
                             <span aria-hidden="true">下一页</span>
                             </a>
                             </li>
                             <li>
                             <a href="#" aria-label="end" data-page="${totalPages}">
                             <span aria-hidden="true">尾页</span>
                             </a>
                             </li>`;
            return list;
        }
        function pages(totalPages,curPage) {
            var list = "";
            //首页，上一页
            list = flist(list,totalPages,curPage);
            //中间分页
            list =mlist(list,totalPages,curPage);
            //下一页尾页
            list =llist(list,totalPages);

            return list;
        }
        //分页加载博客列表
        function showTz(curPage) {
            $.ajax({
                type:"GET",
                url:"data/showTz.php?page="+curPage,
                dataType:"JSON",
                async:false,
                success:function (rsp) {
                    if(rsp.code==0){
                        var totalPages = rsp.pagesCount;
                        //显示消息数据
                        var info = rsp.info;
//                        for(var i=0;i<data.length;i++){
//                            var imgSrc = "";
//                            var index = Math.floor(Math.random()*6+1);
//                            if(data[i].head_img){
//                                imgSrc = "img/headPhoto/"+data[i].head_img;
//                            }else{//如果头像不存在，就使用系统随机生成的头像
//                                imgSrc = "img/headPhoto/"+index+".jpg";
//                            }
//                            data[i].head_img = imgSrc;
//                        }
                        var dataHtml = document.getElementById("tzTemp").innerHTML;
                        var html = template(dataHtml,{info:info});
                        $(".tipList>ul").html(html);
                        //生成分页list
                        $(".pagelist .Page").html(pages(totalPages,curPage));
                    }else if(rsp.code==2){
                        //重新登录
                        $("#loginModal").modal('show');
                    }else{
                        $(".tipList>ul").html("暂无任何帖子");
                    }
                }
            });
        }
        showTz(1);

        function initAction($wrap){
            var $pagelist = $wrap.find(".pagelist").eq(0);
            $pagelist.on('click','li>a:not(.prev,.next)',function (e) {
                e.preventDefault();
                var curPage = parseInt($(this).attr('data-page'));
                showTz(curPage);
            });
            //上一页，下一页
            $pagelist.on('click','.prev',function (e) {
                e.preventDefault();
                var curPage = parseInt($pagelist.find(".nowPage.active>a").attr("data-page"));
                curPage--;
                if(curPage>0){
                    showTz(curPage);
                }else{
                    showTz(1);
                }
            });
            $pagelist.on('click','.next',function (e) {
                e.preventDefault();
                //获取当前页curPage
                var totalPages = $pagelist.find(".totalPage").attr('data-total');
                var curPage = parseInt($pagelist.find(".nowPage.active>a").attr("data-page"));
                curPage++;
                if(curPage<=totalPages){
                    showTz(curPage);
                }else{
                    //获取中页数
                    showTz(totalPages);
                }
            });
        }
        initAction($(".tipList"));
        //查看某条帖子
    })()


</script>


</html>
