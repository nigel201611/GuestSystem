<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/common.css" />
    <title>多用户留言系统-博友</title>
</head>
<style>
    .pageBox .username{
        font-size: 20px;
        line-height: 40px;
        color: #aaaaaa;
        font-weight: 100;
        white-space: normal;
        word-wrap: break-word;
        word-break: break-all;
    }
    .yzcodeImg{
        cursor: pointer;
    }
    .errcheck{
        color: #FF0000;
        display: none;
    }
    .totalPage{
        margin:0 0 0 10px;
    }
    .totalPage,
    .curPage{
        line-height: 30px;
        padding:0 5px;
    }
    .flower{
        color: #FF0000;
    }
    #flowerMenuMask{
        position:absolute;
        left:0;
        top:0;
        width:100%;
        height:100%;
        z-index:999;
        display: none;
        /*background: rgba(255,0,0,.4);*/
    }
    #flowerMenu{
        background: #FFFFFF;
        width:90%;
        height: 150px;
        overflow-y: auto;
        position: absolute;
        z-index:9999;
        display: none;

        border:1px solid #66afe9;
        border-top-color: transparent;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
    }
    #flowerMenu li{
        line-height: 36px;
        height: 36px;
        padding: 0 0 0 20px;
        border-bottom:1px solid #dddddd;
        cursor: pointer;
    }
    #flowerMenu li:not(:last-child){
        border-bottom:1px solid #dddddd;
    }
    #flowerMenu li:hover{
        background-color: #00A2D4;
    }
    .pagelist{
        clear: both;
    }

</style>
<body>
<div class="headerWrap"></div>
<div class="container">
    <div class="pageWrap">
        <div class="pageBox"></div>
        <!--分页list-->
        <div class="pagelist text-center">
            <nav aria-label="Page navigation" class="Page">

            </nav>
        </div>
    </div>
</div>
<div class="footerWrap"></div>

<!--登录模态框-->
<div class="modal fade" tabindex="-1" role="dialog" id="loginModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">登录</h4>
            </div>
            <div class="modal-body">
                <div class="wrap login_wrap">
                    <div class="content">
                        <div class="logo"></div>
                        <div class="login_box">
                            <div class="login_form">
                                <div class="login_title">
                                    登录
                                </div>
                                <form action="#" method="post" id="login_form">
                                    <div class="form_text_ipt">
                                        <input name="username" type="text" placeholder="手机号/邮箱">
                                    </div>
                                    <div class="ececk_warning"><span>请输入手机号或邮箱</span></div>
                                    <div class="ececk_warning loginUsername"><span>手机号或邮箱不存在</span></div>
                                    <div class="ececk_warning phoneAndEmailErr"><span>请输入正确格式的手机号或邮箱</span></div>
                                    <div class="form_text_ipt">
                                        <input name="password" type="password" placeholder="密码">
                                    </div>
                                    <div class="ececk_warning"><span>请输入密码</span></div>
                                    <div class="ececk_warning passwordInput"><span>请检查密码是否输入正确</span></div>
                                    <div class="form_check_ipt">
                                        <div class="left check_left">
                                            <label><input name="autoLogin" data-value="0" type="checkbox"> 下次自动登录</label>
                                        </div>
                                        <div class="right check_right">
                                            <a href="#">忘记密码</a>
                                        </div>
                                    </div>
                                    <div class="form_btn">
                                        <button type="submit">登录</button>
                                    </div>
                                    <div class="form_reg_btn">
                                        <span>还没有帐号？</span><a href="#" id="goRegister" data-toggle="modal" data-target="#registerModal">马上注册</a>
                                    </div>
                                </form>
                                <div class="other_login">
                                    <div class="left other_left">
                                        <span>其它登录方式</span>
                                    </div>
                                    <div class="right other_right">
                                        <a href="#">QQ登录</a>
                                        <a href="#">微信登录</a>
                                        <a href="#">微博登录</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!--content -->
                </div>
            </div><!-- /.modal-body -->
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!--注册模态框-->
<div class="modal fade" tabindex="-1" role="dialog" id="registerModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">注册</h4>
            </div>
            <div class="modal-body">
                <div class="wrap login_wrap">
                    <div class="content">

                        <div class="logo"></div>

                        <div class="login_box">

                            <div class="login_form">
                                <div class="login_title">
                                    注册
                                </div>
                                <form action="#" method="post" id="register_form">

                                    <div class="form_text_ipt">
                                        <input name="username" type="text" placeholder="手机号/邮箱">
                                    </div>
                                    <div class="ececk_warning"><span>手机或者邮箱不能为空</span></div>
                                    <div class="ececk_warning phoneAndEmailErr"><span>请输入正确格式的手机号，邮箱</span></div>
                                    <div class="ececk_warning repeatUser"><span>手机号，邮箱已存在</span></div>
                                    <div class="form_text_ipt">
                                        <input name="password" type="password" placeholder="密码">
                                    </div>
                                    <div class="ececk_warning"><span>密码不能为空</span></div>
                                    <div class="form_text_ipt">
                                        <input name="repassword" type="password" placeholder="重复密码">
                                    </div>
                                    <div class="ececk_warning"><span>密码不能为空</span></div>
                                    <div class="ececk_warning confirmPwd"><span>确认密码和原密码不一致</span></div>
                                    <!--<div class="form_text_ipt">-->
                                        <!--<input name="code" type="text" placeholder="验证码">-->
                                    <!--</div>-->
                                    <!--<div class="ececk_warning"><span>验证码不能为空</span></div>-->

                                    <div class="form_btn">
                                        <button type="submit">注册</button>
                                    </div>
                                    <div class="form_reg_btn">
                                        <span>已有帐号？</span><a href="#" id="goLogin" data-toggle="modal" data-target="#loginModal">马上登录</a>
                                    </div>
                                </form>
                                <div class="other_login">
                                    <div class="left other_left">
                                        <span>其它登录方式</span>
                                    </div>
                                    <div class="right other_right">
                                        <a href="#">QQ登录</a>
                                        <a href="#">微信登录</a>
                                        <a href="#">微博登录</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!--发送信息模态框-->
<div class="modal fade" tabindex="-1" role="dialog" id="sendMessageModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">发送消息</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="sendMessageForm" >
                    <div class="form-group">
                        <label class="col-sm-2 control-label">接收人</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" name="to_user" autocomplete="off">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">消息内容</label>
                        <div class="col-sm-6">
                            <textarea type="text" class="form-control" name="content" autocomplete="off"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-6 errcheck contentEmptyErr" >
                            消息内容不能为空
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">验证码</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" name="yzcode">
                        </div>
                        <div class="col-sm-2">
                            <img class="yzcodeImg" src="data/yzCode.php" alt="单击刷新验证码" title="单击刷新验证码">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-6 errcheck yzcodeErr" >
                            验证码不正确
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-6">
                            <button type="submit" class="btn btn-default">提交</button>
                        </div>
                    </div>
                </form>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!--加好友模态框-->
<div class="modal fade" tabindex="-1" role="dialog" id="addFriendModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">加好友</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="addFriendForm" >
                    <div class="form-group">
                        <label class="col-sm-2 control-label">昵称</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" name="to_user" autocomplete="off">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">加好友信息</label>
                        <div class="col-sm-6">
                            <textarea type="text" class="form-control" name="content" autocomplete="off">您好，期待认识您!</textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-6 errcheck contentEmptyErr" >
                            消息内容不能为空
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">验证码</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" name="yzcode">
                        </div>
                        <div class="col-sm-2">
                            <img class="yzcodeImg" src="data/yzCode.php" alt="单击刷新验证码" title="单击刷新验证码">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-6 errcheck yzcodeErr" >
                            验证码不正确
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-6">
                            <button type="submit" class="btn btn-default">提交</button>
                        </div>
                    </div>
                </form>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!--送花模态框-->
<div class="modal fade" tabindex="-1" role="dialog" id="sendFlowerModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">送花</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="sendFlowerForm" >
                    <div class="form-group">
                        <label class="col-sm-2 control-label">接收者</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" name="to_user" autocomplete="off">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">花朵数量</label>
                        <div class="col-sm-6">
                            <input type="text" name="flowerCount" class="form-control">
                            <ul id="flowerMenu">
                                <li data-value="1">
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                </li>
                                <li data-value="2">
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                </li>
                                <li data-value="3">
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                </li>
                                <li data-value="4">
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                </li>
                                <li data-value="5">
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                </li>
                                <li data-value="6">
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                </li>
                                <li data-value="7">
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                </li>
                                <li data-value="8">
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                </li>
                                <li data-value="9">
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                    <span class="glyphicon glyphicon-apple flower"></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">送花信息</label>
                        <div class="col-sm-6">
                            <textarea type="text" class="form-control" name="content" autocomplete="off"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">验证码</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" name="yzcode">
                        </div>
                        <div class="col-sm-2">
                            <img class="yzcodeImg" src="data/yzCode.php" alt="单击刷新验证码" title="单击刷新验证码">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-6 errcheck yzcodeErr" >
                            验证码不正确
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-6">
                            <button type="submit" class="btn btn-default">送花</button>
                        </div>
                    </div>
                    <div id="flowerMenuMask"></div>
                </form>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

</body>
<script src="js/jquery-1.11.3.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/common.js"></script>
<script src="js/login_register.js"></script>

<script src="js/themes/default.js"></script>
<script src="js/noty.min.js"></script>
<script src="js/template.js"></script>
<!--分页模板-->
<script id="pageTemp" type="text/html">
    <%for(var i = 0; i < data.length; i++) {%>
    <div class="col-sm-6 col-md-3">
        <div class="thumbnail">
            <img src="<%:=data[i].head_img%>" alt="<%:=data[i].username%>" style="width: 200px;height: 200px;">
            <div class="caption">
                <h3 class="username"><%:=data[i].username%></h3>
                <div class="btnlist">
                    <p class="btn_group">
                        <a href="#" class="btn btn-primary sendMessage" role="button" data-id="<%:=data[i].id%>"><span class="glyphicon glyphicon-phone"></span>发消息</a>
                        <a href="#" class="btn btn-primary writeMessage" role="button" data-id="<%:=data[i].id%>"><span class="glyphicon glyphicon-phone"></span>写留言</a>
                    </p>
                    <p class="btn_group">
                        <a href="#" class="btn btn-default addFriend" role="button" data-id="<%:=data[i].id%>"><span class="glyphicon glyphicon-user"></span>加好友</a>
                        <a href="#" class="btn btn-default addFlower" role="button" data-id="<%:=data[i].id%>"><span class="glyphicon glyphicon-heart-empty"></span>送花</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <%}%>
</script>
<script>
    (function () {

        $('.headerWrap').load('common.inc/header.html',function () {
            var userInfo;
            if(window.localStorage.getItem('userInfo')){
                userInfo = JSON.parse(window.localStorage.getItem('userInfo'));
            }
            if(userInfo && userInfo.username){
                username = userInfo.username;
                $('.headerWrap').find('.username').text(userInfo.username);
                $('.headerWrap').find('.login').hide();
                $('.headerWrap').find('.register').hide();
                $('.headerWrap').find(".loginOut").removeClass('hidden');

                //请求信息接口，获取未查看信息条数
                $.get("data/getMessageCount.php?username="+userInfo.username,function (count) {
                    if(count>0){
                        $(".envelope_count").text(count).css({display:"inline-block"});
                    }
                });

                //消息增加点击事件，跳转到信息查看页面
                $('.envelope_wrap').click(function () {
                    var menuList = [0,0,1,0,0,0];
                    localStorage.setItem("menuList",JSON.stringify(menuList));
                    location.href = 'person_center.html';
                });

            }
        });
        $('.footerWrap').load('common.inc/footer.html');
        var username;
        var to_user;
        //   关闭模态框，清空数据
        function clearModal($modal){
            $modal.on('show.bs.modal',function () {
                //输入之前，清空表单内容
                $modal.find("input[name=to_user]").eq(0).val("");
                $modal.find("textarea[name=content]").eq(0).val("");
                $modal.find("input[name=yzcode]").eq(0).val("");
                $modal.find("input[name=yzcode]").eq(0).val("");
                $modal.find("img.yzcodeImg").eq(0).attr('src',"data/yzCode.php");
                $modal.find(".errcheck").hide();
            });

        }
        //   验证码验证相关函数
        function yzcodeCheck($form){
            //验证码判断
            $form.on('blur keyup','input[name=yzcode]',function () {
                var yzcode = $(this).val();
                //验证用户输入的验证码是否和服务器端生成的一样
                if(yzcode != getCookie('yzcode')){
                    $form.find(".yzcodeErr").show();
                    //提交禁用
                    $form.find("button[type=submit]").attr('disabled',true);
                    return;
                }else{
                    $form.find(".yzcodeErr").hide();
                    $form.find("button[type=submit]").attr('disabled',false);
                }
            });
            $form.on('focus','input[name=yzcode]',function () {
                $form.find(".yzcodeErr").hide();
            });
            $form.on('click','.yzcodeImg',function () {
                this.src= "data/yzCode.php";
            });

        }
        //   提示函数
        function notyInfo(data){
            noty({
                text: data,
                layout: "center",
                type: "warning",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '关闭',
                        onClick: function ($noty) {
                            $noty.close();
                        }
                    }
                ]
            });
        }
        //   表单提交--信息提交和加好友
        function formSubmit($form,$modal,url,flag){
            $form.submit(function (e) {
                e.preventDefault();
                var data = $(this).serializeArray();
                console.log(data);
                var postData;
                if(flag==0){
                    var content = data[1].value,
                        yzcode = data[2].value;
                    postData = {
                            'to_user':to_user,
                            'content':content
                        };
                }else if(flag==1){
                    var  flowerCount = data[1].value,
                        content = data[2].value,
                        yzcode = data[3].value;
                    postData = {
                            'to_user':to_user,
                            'content':content,
                            'flowerCount':flowerCount
                        };
                }

                //验证码判断
                if(yzcode != getCookie('yzcode') || yzcode==''){
                    $form.find(".yzcodeErr").show();
                    //提交禁用
                    $form.find("button[type=submit]").attr('disabled',true);
                    return;
                }else{
                    $form.find(".yzcodeErr").hide();
                    //提交禁用
                    $form.find("button[type=submit]").attr('disabled',false);
                }
                //发送的消息内容不能为空
                if(!content){
                    $form.find(".contentEmptyErr").show();
                    return;
                }else{
                    $form.find(".contentEmptyErr").hide();
                }


                $.ajax({
                    type:"POST",
                    url:url,
                    dataType:"JSON",
                    data:postData,
                    success:function (rsp) {
                        if(rsp.code == 1){
                            //关闭发送消息模态框
                            $modal.modal("hide");
                            notyInfo("发送成功");
                            //使能发送消息按钮
                        }else if(rsp.code == 2){
                            //登录状态失效，重新登录
                            $modal.modal("hide");
                            $("#loginModal").modal('show');
                        }else if(rsp.code == -1){
                            notyInfo("发送失败");
                        }
                    }
                });

            });
        }

        //分页相关函数
        function mlist(list,totalPages,curPage) {
            if(totalPages>=5){  //总页数大于等于5的情况下
                var num = 2;//一个中间分隔数
                //1,2,
                if(curPage>num && curPage<=(totalPages-num) ){ //正常情况下
                    for(var i=num;i>0;i--){
                        var n = curPage-i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                    list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                    //3,4
                    for(var i=1;i<=num;i++){
                        var n = curPage+i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                }else if(curPage<=num){//如果当前页小于$num，也要同时显示5个
                    for(var i=curPage-1;i>0;i--){
                        var n = curPage-i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                    list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                    //3,4
                    for(var i=1;i<=num+(num-curPage+1);i++){//!!! 2-3,1-4
                        var n = curPage+i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                }else if( curPage>totalPages-num ){ //如果当前页大于于$totoalPage，也要同时显示5个
                    for(var i=num+(curPage-totalPages+num);i>0;i--){ //16,17,18||16,17,18,19--19-3,20-4
                        var n = curPage-i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                    list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                    //3,4
                    for(var i=(curPage-totalPages+num);i<num;i++){ //19-1,20-0
                        var n = curPage+i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                }
            }else{ //总页数小于5时
                for(var i=1;i<curPage;i++){
                    list += `<li><a href="#" data-page="${i}">${i}</a></li>`;
                }
                list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                for(var i=curPage+1;i<=totalPages;i++){
                    list += `<li><a href="#" data-page="${i}">${i}</a></li>`;
                }

            }
            return list;
        }
        function flist(list, totalPages,curPage) {
            list += `<ul class="pagination">
                             <span class="totalPage" data-total="${totalPages}">共${totalPages}页</span>
                             <span class="curPage">当前第${curPage}页</span>
                             <li>
                             <a href="#" aria-label="first" data-page="1">
                             <span aria-hidden="true">首页</span>
                             </a>
                             </li>
                           <li>
                             <a href="#" aria-label="Previous" class="prev">
                             <span aria-hidden="true">上一页</span>
                             </a>`;
            return list;
        }
        function llist(list,totalPages){
            list += `<li>
                             <a href="#" aria-label="Next" class="next">
                             <span aria-hidden="true">下一页</span>
                             </a>
                             </li>
                             <li>
                             <a href="#" aria-label="end" data-page="${totalPages}">
                             <span aria-hidden="true">尾页</span>
                             </a>
                             </li>`;
            return list;
        }
        function pages(totalPages,curPage) {
            var list = "";
            //首页，上一页
            list = flist(list,totalPages,curPage);
            //中间分页
            list =mlist(list,totalPages,curPage);
            //下一页尾页
            list =llist(list,totalPages);

            return list;
        }
        //分页加载博客列表
        function showBloger(curPage) {
            $.ajax({
                type:"GET",
                url:"data/getBloger.php?page="+curPage,
                dataType:"JSON",
                async:false,
                success:function (rsp) {
                    if(rsp.code==0){
                        var totalPages = rsp.pagesCount;
                        //显示消息数据
                        var data = rsp.info;
                        for(var i=0;i<data.length;i++){
                            var imgSrc = "";
                            var index = Math.floor(Math.random()*6+1);
                            if(data[i].head_img){
                                imgSrc = "img/headPhoto/"+data[i].head_img;
                            }else{//如果头像不存在，就使用系统随机生成的头像
                                imgSrc = "img/headPhoto/"+index+".jpg";
                            }
                            data[i].head_img = imgSrc;

                        }
                        var dataHtml = document.getElementById("pageTemp").innerHTML;
                        var html = template(dataHtml,{data:data});
                        $(".pageBox").html(html);
                        //生成分页list
                        $(".pagelist .Page").html(pages(totalPages,curPage));
                    }else if(rsp.code==2){
                        //重新登录
                        $("#loginModal").modal('show');
                    }
                }
            });
        }
        showBloger(1);
        function initAction($wrap){
            var $pagelist = $wrap.find(".pagelist").eq(0);
            $pagelist.on('click','li>a:not(.prev,.next)',function (e) {
                e.preventDefault();
                var curPage = parseInt($(this).attr('data-page'));
                showBloger(curPage);
            });
            //上一页，下一页
            $pagelist.on('click','.prev',function (e) {
                e.preventDefault();
                var curPage = parseInt($pagelist.find(".nowPage.active>a").attr("data-page"));
                curPage--;
                if(curPage>0){
                    showBloger(curPage);
                }else{
                    showBloger(1);
                }
            });
            $pagelist.on('click','.next',function (e) {
                e.preventDefault();
                //获取当前页curPage
                var totalPages = $pagelist.find(".totalPage").attr('data-total');
                var curPage = parseInt($pagelist.find(".nowPage.active>a").attr("data-page"));
                curPage++;
                if(curPage<=totalPages){
                    showBloger(curPage);
                }else{
                    //获取中页数
                    showBloger(totalPages);
                }
            });
        }
        initAction($(".pageWrap"));

        /*---------------------发信息--------------------------------------*/
        //发送消息
        var $sendMessageModal = $("#sendMessageModal");
        var $sendMessageForm = $("#sendMessageForm");

        $(".pageBox").on('click','.sendMessage',function () {
            //打开发送消息模态框
            to_user = $(this).parents(".thumbnail").find(".username").eq(0).text();
            var from_user = username;
            //判断发送者不能和接收者相同
            if(to_user==from_user){
                notyInfo('不能向自己发送消息');
                return;
            }
            $sendMessageModal.modal('show');
            $sendMessageForm.find("input[name=to_user]").attr('readonly',true);
            $sendMessageForm.find("input[name=to_user]").val(to_user);
        });
        //提交数据，发送消息
        var messageurl = "data/sendMessage.php";
        formSubmit($sendMessageForm,$sendMessageModal,messageurl,0);
        //验证码相关判断
        yzcodeCheck($sendMessageForm);
        //关闭模态框，清空数据
        clearModal($sendMessageModal);
        /*---------------------加好友--------------------------------------*/
        var $addFriendModal = $("#addFriendModal");
        var $addFriendForm = $("#addFriendForm");

        $(".pageBox").on('click','.addFriend',function (e) {
            e.preventDefault();
            //打开发送消息模态框
            to_user = $(this).parents(".thumbnail").find(".username").eq(0).text();
            //验证是否已经是好友
            $.ajax({
                type:"POST",
                url:"data/isFriend.php",
                dataType:"JSON",
                async:false,
                data:{
                    to_user:to_user
                },
                success:function (rsp) {
                    if(rsp.code == 3){
                        notyInfo("已经是好友或者还处于待验证状态");
                    }else if(rsp.code == 0){
                        var from_user = username;
                        //判断发送者不能和接收者相同
                        if(to_user==from_user){
                            notyInfo('不能和自己加好友');
                            return;
                        }
                        $addFriendModal.modal('show');
                        $addFriendForm.find("input[name=to_user]").attr('readonly',true);
                        $addFriendForm.find("input[name=to_user]").val(to_user);
                    }else if(rsp.code == 2){
                        //登录状态失效，重新登录
                        $("#loginModal").modal('show');
                    }else if(rsp.code == -1){
                        notyInfo("添加失败,尝试关闭浏览器重新登录试试");
                    }
                }
            });

        });
        var friendUrl = "data/addFriend.php";
        // 发送好友请求
        formSubmit($addFriendForm,$addFriendModal,friendUrl,0);
        //提交数据前验证码验证
        yzcodeCheck($addFriendForm);
        //关闭模态框失，清空数据
        clearModal($addFriendModal);
        /*---------------------送花--------------------------------------*/
        //送花功能
        var $sendFlowerModal = $("#sendFlowerModal");
        var $sendFlowerForm = $("#sendFlowerForm");

        $(".pageBox").on('click','.addFlower',function (e) {
            e.preventDefault();
            //打开发送消息模态框
            to_user = $(this).parents(".thumbnail").find(".username").eq(0).text();
            var from_user = username;
            //判断发送者不能和接收者相同
            if(to_user==from_user){
                notyInfo('不能向自己送花');
                return;
            }
            $sendFlowerModal.modal('show');
            $sendFlowerForm.find("input[name=to_user]").attr('readonly',true);
            $sendFlowerForm.find("input[name=to_user]").val(to_user);
        });
        var flowerUrl = "data/sendFlower.php";
        // 发送好友请求
        formSubmit($sendFlowerForm,$sendFlowerModal,flowerUrl,1);
        //提交数据前验证码验证
        yzcodeCheck($sendFlowerModal);
        //关闭模态框失，清空数据
        clearModal($sendFlowerModal);
        //单击送花，弹出送花列表
        function initSendFlower() {
            $("body").on('click','input[name=flowerCount]',function () {
                if(!$(this).hasClass("open")){
                    $(this).addClass("open");
                    $("#flowerMenuMask").show();
                    $("#flowerMenu").show();
                }
            });
            function closeflowerMenu(){
                $("input[name=flowerCount]").removeClass("open");
                $("#flowerMenuMask").hide();
                $("#flowerMenu").hide();
            }
            $("body").on('click','#flowerMenuMask',function () {
                closeflowerMenu();
            });
            //回写下拉菜单数量
            $("body").on("click",'#flowerMenu li',function () {
                var value = $(this).attr("data-value");
                closeflowerMenu();
                $("input[name=flowerCount]").val(value);
            });

            $sendFlowerModal.on('hide.bs.modal',function () {
                //清空表单内容
                $sendFlowerModal.find("input[name=flowerCount]").val("");
                closeflowerMenu();
            });
        }
        initSendFlower();
    })();

</script>

</html>