<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="zyupload/skins/zyupload-1.0.0.min.css " type="text/css">
    <title>多用户留言系统-个人中心</title>
</head>

<style>
    .wrapItem{
        display: none;
    }
    .wrapItem.active{
        display: block;
    }
    .errcheck{
        color: #FF0000;
        display: none;
    }
    .yzcodeImg{
        cursor: pointer;
    }
    .form-control[readonly]{
         background-color: #ffffff;
        opacity: 1;
    }
   .personInfoWrap .label-title{
       font-weight:bold;
       display: inline-block;
       width: 60px;
       text-align: right;
   }
    .personInfoWrap .label-content{
        display: inline-block;
        white-space: normal;
        word-break: break-all;
        word-wrap: break-word;
    }
    .personInfoWrap .personinfo_content{
        padding: 0 10px;
    }

    .loadingWrap{
        width:100%;
        height:100%;
        position: fixed;
        top:0;
        left:0;
        background: rgba(0,0,0,0.3);
        display: none;
    }
    .loadingWrap img{
        position: absolute;
        width: 100px;
        top:50%;
        left:50%;
        display: block;
        transform: translate(-50%,-50%);
    }

    .allCheck{
        margin:0 0 20px 0;
    }
    .totalPage{
        margin:0 0 0 10px;
    }
    .totalPage,
    .curPage{
        line-height: 30px;
        padding:0 5px;
    }
    .buttonList{
        float: right;
        overflow: hidden;
    }
    .buttonList label{
        position: relative;
        top:-2px;
    }
    .showMessageWrap table tr,
    .friendWrap table tr,
    .flowerWrap table tr{
        cursor: pointer;
    }
    .noty_text{
        white-space: normal;
        word-wrap:break-word;
        word-break:break-all;
    }
    .deleteAll,
    .readAll,
    .validateAll{
        float: left;
        margin:0 0 0 10px;
    }
    .pagelist{
        clear: both;
    }

    .text-success{
        color: #3c763d;
    }
    .flower{
        color: #FF0000;
    }


</style>
<body>
    <div class="headerWrap"></div>
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="panel panel-default panel-primary">
                    <div class="panel-heading">
                        账号管理
                    </div>
                    <div class="panel-body">
                        <ul class="list-group">
                            <li class="list-group-item"><a href="#" id="personInfo">个人信息</a></li>
                            <li class="list-group-item"><a href="#" id="modifyInfo">修改资料</a></li>
                        </ul>
                    </div>
                </div>

                <div class="panel panel-default panel-primary">
                    <div class="panel-heading">
                        其他管理
                    </div>
                    <div class="panel-body othersManage">
                        <ul class="list-group">
                            <li class="list-group-item"><a href="#showMessageWrap">短信查阅</a></li>
                            <li class="list-group-item"><a href="#friendWrap">好友设置</a></li>
                            <li class="list-group-item"><a href="#flowerWrap">查询花朵</a></li>
                            <li class="list-group-item"><a href="#personPhotoWrap">个人相册</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="panel panel-default panel-primary">
                    <div class="panel-heading">
                        会员管理中心
                    </div>
                    <div class="panel-body">
<!--账号管理-->
                        <!--个人信息展示-->
                        <div class="personInfoWrap wrapItem">
                            <ul class="list-group">
                                <li class="list-group-item username">
                                    <span class="label-title">用户名:</span>
                                    <span class="label-content"></span>
                                </li>
                                <li class="list-group-item email">
                                    <span class="label-title">邮箱:</span>
                                    <span class="label-content"></span>
                                </li>
                                <li class="list-group-item qq">
                                    <span class="label-title">qq:</span>
                                    <span class="label-content"></span>
                                </li>
                                <li class="list-group-item register_time">
                                    <span class="label-title">注册时间:</span>
                                    <span class="label-content"></span>
                                </li>
                                <li class="list-group-item login_count">
                                    <span class="label-title">登录次数:</span>
                                    <span class="label-content"></span>
                                </li>
                                <li class="list-group-item">
                                    <span class="label-title">头像:</span>
                                    <span class="label-content">
                                        <img class="person_img" src="img/headPhoto/1.jpg" alt="个人头像" style="width:60px;height:60px;">
                                    </span>
                                </li>
                                <li class="list-group-item person_info">
                                    <span class="label-title">个人简介:</span>
                                    <span class="label-content personinfo_content"></span>
                                </li>
                            </ul>

                            <!--加载动画-->
                            <div class="loadingWrap">
                                <img src="img/loading.gif" alt="加载中...">
                            </div>
                        </div>
                        <!--修改资料-->
                        <div class="modifyWrap wrapItem">
                            <form class="form-horizontal" id="modifyinfoForm">
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">用户名</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" name="username">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-6 col-sm-offset-2 errcheck errcheck_repeat">
                                       用户名已经存在
                                    </div>
                                    <div class="col-sm-6 col-sm-offset-2 errcheck errcheck_empty">
                                        用户名不能为空
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">邮箱</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" name="email">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">qq</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" name="qq">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">个人简介</label>
                                    <div class="col-sm-6">
                                        <textarea class="form-control" name="person_info" cols="30" rows="10"></textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">验证码</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" name="yzcode">
                                    </div>
                                    <div class="col-sm-2">
                                        <img class="yzcodeImg" src="data/yzCode.php" alt="单击刷新验证码" title="单击刷新验证码">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-offset-2 col-sm-6 errcheck yzcodeErr" >
                                        验证码不正确
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-offset-2 col-sm-6">
                                        <button type="submit" class="btn btn-default">提交</button>
                                    </div>
                                </div>
                            </form>

                            <div class="form-group">
                                    <label class="col-sm-2 control-label">个人头像</label>
                                    <div class="col-sm-8">
                                        <div id="zyupload" class="zyupload"></div>
                                    </div>
                            </div>
                        </div>

<!--其他管理-->
                        <!--短信查询-->
                        <div class="showMessageWrap wrapItem" id="showMessageWrap">
                                <table class="table table-responsive table-hover table-bordered">
                                    <thead>
                                        <tr>
                                            <td>发送人</td>
                                            <td>接收人</td>
                                            <td>消息内容</td>
                                            <td>日期</td>
                                            <td style="text-align: center">状态</td>
                                            <td style="text-align: center">操作</td>
                                        </tr>
                                    </thead>
                                    <tbody>

                                    </tbody>
                                </table>
                                <div class="buttonList">
                                    <div class="deleteAll">
                                        <input type="checkbox" class="allCheck">
                                        <label>删除本页</label>
                                    </div>
                                    <div class="readAll">
                                        <input type="checkbox" class="allRead">
                                        <label>全部已读</label>
                                    </div>
                                </div>
                                <!--分页list-->
                                <div class="pagelist text-center">
                                    <nav aria-label="Page navigation" class="Page">

                                    </nav>
                                </div>
                            </div>
                        <!--好友设置-->
                        <div class="friendWrap wrapItem" id="friendWrap">
                            <!--只显示加当前用户的好友-->
                            <table class="table table-responsive table-hover table-bordered">
                                <thead>
                                <tr>
                                    <td>添加人</td>
                                    <td>验证好友内容</td>
                                    <td>日期</td>
                                    <td style="text-align: center">状态</td>
                                    <td style="text-align: center">操作</td>
                                </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                            <div class="buttonList">
                                <div class="deleteAll">
                                    <input type="checkbox" class="allCheck">
                                    <label>删除本页</label>
                                </div>
                                <div class="readAll">
                                    <input type="checkbox" class="allRead">
                                    <label>全部验证</label>
                                </div>
                            </div>
                            <!--分页list-->
                            <div class="pagelist text-center">
                                <nav aria-label="Page navigation" class="Page">

                                </nav>
                            </div>
                        </div>
                        <!--查询花朵-->
                        <div class="flowerWrap wrapItem" id="flowerWrap">
                            <table class="table table-responsive table-hover table-bordered">
                                <thead>
                                <tr>
                                    <td>送花者</td>
                                    <td>送花附加内容</td>
                                    <td>日期</td>
                                    <td style="text-align: center">花朵数量</td>
                                    <td style="text-align: center">操作</td>
                                </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                            <div class="buttonList">
                                <div class="deleteAll">
                                    <input type="checkbox" class="allCheck">
                                    <label>删除本页</label>
                                </div>
                            </div>
                            <!--分页list-->
                            <div class="pagelist text-center">
                                <nav aria-label="Page navigation" class="Page">

                                </nav>
                            </div>
                        </div>
                        <!--个人相册-->
                        <div class="personPhotoWrap wrapItem" id="personPhotoWrap">
                            个人相册
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="footerWrap"></div>

    <!--登录模态框-->
    <div class="modal fade" tabindex="-1" role="dialog" id="loginModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">登录</h4>
                </div>
                <div class="modal-body">
                    <div class="wrap login_wrap">
                        <div class="content">
                            <div class="logo"></div>
                            <div class="login_box">
                                <div class="login_form">
                                    <div class="login_title">
                                        登录
                                    </div>
                                    <form action="#" method="post" id="login_form">
                                        <div class="form_text_ipt">
                                            <input name="username" type="text" placeholder="手机号/邮箱">
                                        </div>
                                        <div class="ececk_warning"><span>请输入手机号或邮箱</span></div>
                                        <div class="ececk_warning loginUsername"><span>手机号或邮箱不存在</span></div>
                                        <div class="ececk_warning phoneAndEmailErr"><span>请输入正确格式的手机号或邮箱</span></div>
                                        <div class="form_text_ipt">
                                            <input name="password" type="password" placeholder="密码">
                                        </div>
                                        <div class="ececk_warning"><span>请输入密码</span></div>
                                        <div class="ececk_warning passwordInput"><span>请检查密码是否输入正确</span></div>
                                        <div class="form_check_ipt">
                                            <div class="left check_left">
                                                <label><input name="autoLogin" data-value="0" type="checkbox"> 下次自动登录</label>
                                            </div>
                                            <div class="right check_right">
                                                <a href="#">忘记密码</a>
                                            </div>
                                        </div>
                                        <div class="form_btn">
                                            <button type="submit">登录</button>
                                        </div>
                                        <div class="form_reg_btn">
                                            <span>还没有帐号？</span><a href="#" id="goRegister" data-toggle="modal" data-target="#registerModal">马上注册</a>
                                        </div>
                                    </form>
                                    <div class="other_login">
                                        <div class="left other_left">
                                            <span>其它登录方式</span>
                                        </div>
                                        <div class="right other_right">
                                            <a href="#">QQ登录</a>
                                            <a href="#">微信登录</a>
                                            <a href="#">微博登录</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!--content -->
                    </div>
                </div><!-- /.modal-body -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <!--注册模态框-->
    <div class="modal fade" tabindex="-1" role="dialog" id="registerModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">注册</h4>
                </div>
                <div class="modal-body">
                    <div class="wrap login_wrap">
                        <div class="content">

                            <div class="logo"></div>

                            <div class="login_box">

                                <div class="login_form">
                                    <div class="login_title">
                                        注册
                                    </div>
                                    <form action="#" method="post" id="register_form">

                                        <div class="form_text_ipt">
                                            <input name="username" type="text" placeholder="手机号/邮箱">
                                        </div>
                                        <div class="ececk_warning"><span>手机或者邮箱不能为空</span></div>
                                        <div class="ececk_warning phoneAndEmailErr"><span>请输入正确格式的手机号，邮箱</span></div>
                                        <div class="ececk_warning repeatUser"><span>手机号，邮箱已存在</span></div>
                                        <div class="form_text_ipt">
                                            <input name="password" type="password" placeholder="密码">
                                        </div>
                                        <div class="ececk_warning"><span>密码不能为空</span></div>
                                        <div class="form_text_ipt">
                                            <input name="repassword" type="password" placeholder="重复密码">
                                        </div>
                                        <div class="ececk_warning"><span>密码不能为空</span></div>
                                        <div class="ececk_warning confirmPwd"><span>确认密码和原密码不一致</span></div>
                                        <div class="form_text_ipt">
                                            <input name="code" type="text" placeholder="验证码">
                                        </div>
                                        <div class="ececk_warning"><span>验证码不能为空</span></div>

                                        <div class="form_btn">
                                            <button type="submit">注册</button>
                                        </div>
                                        <div class="form_reg_btn">
                                            <span>已有帐号？</span><a href="#" id="goLogin" data-toggle="modal" data-target="#loginModal">马上登录</a>
                                        </div>
                                    </form>
                                    <div class="other_login">
                                        <div class="left other_left">
                                            <span>其它登录方式</span>
                                        </div>
                                        <div class="right other_right">
                                            <a href="#">QQ登录</a>
                                            <a href="#">微信登录</a>
                                            <a href="#">微博登录</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

<!--资料修改成功提示模态框-->
    <div class="modal fade" tabindex="-1" role="dialog" id="modifySuccessModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">信息修改提示框</h4>
                </div>
                <div class="modal-body">
                    个人信息修改成功！
                </div><!-- /.modal-body -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <!--资料修改失败提示模态框-->
    <div class="modal fade" tabindex="-1" role="dialog" id="modifyFailModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">信息修改提示框</h4>
                </div>
                <div class="modal-body">
                    非法操作！请重新登录再次修改试试！
                </div><!-- /.modal-body -->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->




</body>
<script src="js/jquery-1.11.3.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/common.js"></script>
<script src="js/login_register.js"></script>
<script type="text/javascript" src="zyupload/zyupload.basic-1.0.0.min.js"></script>
<script src="js/themes/default.js"></script>
<script src="js/noty.min.js"></script>
<script src="js/template.js"></script>
<!--显示消息模板-->
<script id="messageTemp" type="text/html">
    <%for(var i = 0; i < info.length; i++) {%>
        <tr data-id="<%:=info[i].id%>">
            <td><%:=info[i].from_user%></td>
            <td><%:=info[i].to_user%></td>
            <td><%:=info[i].message_content%></td>
            <td><%:=info[i].message_date%></td>
            <td style="text-align: center">
                <%if(info[i].message_state==0){%>
                <span class="glyphicon glyphicon-envelope envelope notWatched" title="未读信息"></span>
                <%}else if(info[i].message_state==1){%>
                <span class="glyphicon glyphicon-envelope envelope" title="已读信息"></span>
                <%}%>
            </td>
            <td style="text-align: center"><label><input title="单击可以删除该条信息" type="checkbox" class="delete"  data-id="<%:=info[i].id%>"></label></td>
        </tr>
    <%}%>
</script>
<!--显示好友模板-->
<script id="friendTemp" type="text/html">
    <%for(var i = 0; i < info.length; i++) {%>
    <tr data-id="<%:=info[i].id%>">
        <td><%:=info[i].from_user%></td>
        <td><%:=info[i].friend_content%></td>
        <td><%:=info[i].friend_date%></td>
        <td style="text-align: center">
            <%if(info[i].friend_state==0){%>
                <span class="glyphicon glyphicon-remove validate notValidate" title="未认证"></span>
            <%}else if(info[i].friend_state==1){%>
                <span class="glyphicon glyphicon-ok validate" title="已认证"></span>
            <%}%>
        </td>
        <td style="text-align: center"><label><input title="单击可以删除该条信息" type="checkbox" class="delete"  data-id="<%:=info[i].id%>"></label></td>
    </tr>
    <%}%>
</script>
<!--显示花朵模板-->
<script id="flowerTemp" type="text/html">
    <%for(var i = 0; i < info.length; i++) {%>
    <tr data-id="<%:=info[i].id%>">
        <td><%:=info[i].from_user%></td>
        <td><%:=info[i].flower_content%></td>
        <td><%:=info[i].flower_date%></td>
        <td style="text-align: center">
            <span class="text-success"><%:=info[i].flower_count%></span>
            <span class="glyphicon glyphicon-apple flower"></span>
        </td>
        <td style="text-align: center"><label><input title="单击可以删除该条信息" type="checkbox" class="delete"  data-id="<%:=info[i].id%>"></label></td>
    </tr>
    <%}%>
</script>

<script>
    (function(){
        function notyInfo(data){
            noty({
                text: data,
                layout: "center",
                type: "warning",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '关闭',
                        onClick: function ($noty) {
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function notyInfo2(data,url,flag,that,checkList){
            noty({
                text: data.msg,
                layout: "center",
                type: "warning",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-success btn-xs',
                        text: '确认',
                        onClick: function ($noty) {
                            //删除记录
                            $.ajax({
                                type:"GET",
                                url:url,
                                dataType:"json",
                                success:function (rsp) {
                                    console.log(flag);
                                    if(rsp.code == 0){  //删除成功
                                        notyInfo("success");
                                        if(flag==1){  //message
                                            showMessage(1);//从第一页开始
                                        }else if(flag==2){  //friend
                                            showFriend(1);//从第一页开始
                                        }else if(flag==3){
                                            showflower(1);
                                        }
                                    }else if(rsp.code == 1){  //重新登录
                                        $("#loginModal").modal('show');
                                    }
                                }
                            });
                            $noty.close();
                        }
                    },
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '取消',
                        onClick: function ($noty) {
                            $(that).prop('checked',false);
                            for(var i=0;i<checkList.length;i++){
                                $(checkList[i]).prop("checked",false);
                            }
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function notyInfo22(data,url,flag,that){
            noty({
                text: data.msg,
                layout: "center",
                type: "warning",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-success btn-xs',
                        text: '确认',
                        onClick: function ($noty) {
                            //删除记录
                            $.ajax({
                                type:"GET",
                                url:url,
                                dataType:"json",
                                success:function (rsp) {
                                    if(rsp.code == 0){  //删除成功
                                        notyInfo("success");
                                        if(flag==1){  //message
                                            showMessage(1);//从第一页开始
                                        }else if(flag==2){  //friend
                                            showFriend(1);//从第一页开始
                                        }else if(flag==3){
                                            showflower(1);
                                        }

                                    }else if(rsp.code == 1){  //重新登录
                                        $("#loginModal").modal('show');
                                    }
                                }
                            });
                            $noty.close();
                        }
                    },
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '取消',
                        onClick: function ($noty) {
                            $(that).prop('checked',false);
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function notyInfo3(data){
            noty({
                text: data,
                layout: "center",
                type: "default",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '关闭',
                        onClick: function ($noty) {
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function notyInfo32(data,that,flag,id){
            noty({
                text: data,
                layout: "center",
                type: "default",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-success btn-xs',
                        text: '通过',
                        onClick: function ($noty) {
                            if(flag){ //如果之前没有通过验证
                                $.getJSON('data/setFriendValidate.php?ids='+id,function (rsp) {
                                    if(rsp.code==0){
                                        //设置成已认证
                                        $(that).find(".validate").removeClass("notValidate glyphicon-remove").addClass("glyphicon-ok"); //!!!

                                    }else if(rsp.code==2){
                                        //登录时间过期，请重新登录
                                        $("#loginModal").modal('show');
                                    }
                                });
                            }
                            $noty.close();
                        }
                    },
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '关闭',
                        onClick: function ($noty) {
                            $noty.close();
                        }
                    }
                ]
            });
        }
        function notyInfo4(data,url,flag,that){
            noty({
                text: data.msg,
                layout: "center",
                type: "warning",
                modal: true,
                buttons: [
                    {
                        addClass: 'btn btn-success btn-xs',
                        text: '确认',
                        onClick: function ($noty) {
                            //删除记录
                            $.ajax({
                                type:"GET",
                                url:url,
                                dataType:"json",
                                success:function (rsp) {
                                    if(rsp.code == 0){
                                        if(flag==1){ //1-message
                                            $(".envelope").removeClass("notWatched");
                                            //同时设置头部上的信息数量
                                            $(".envelope_count").text(0).css({display:"none"});
                                        }else if(flag==2){ //2-friend
                                            $(".validate").removeClass("notValidate glyphicon-remove").addClass("glyphicon-ok");
                                        }

                                    }else if(rsp.code == 2){  //重新登录
                                        $("#loginModal").modal('show');
                                    }
                                }
                            });
                            $noty.close();
                        }
                    },
                    {
                        addClass: 'btn btn-primary btn-xs',
                        text: '取消',
                        onClick: function ($noty) {
                            $(that).prop("checked",false);
                            $noty.close();
                        }
                    }
                ]
            });
        }
        //1-代表当前active,分别对应个人信息，修改资料，短信查询，好友设置，查询花朵，个人相册
        var menuList = [0,0,0,0,0,0];
        var messageArr = []; //用来保存消息数组
        var friendArr = [];//用来保存好友数组
        var flowerArr = [];//用来保存花朵的数组
        //从本地存储读取menuList

        //个人中心，首先需要登录，用户表，增加1 注册时间字段，用户2 客户端所在ip字段，3 登录次数字段，uinique,active等字段
        //其中unique用来安全防护，active用来激活邮箱用
        //另外增加可选的邮箱，qq，头像，个人简介字段
        function getPersonInfo(username){
            //请求个人信息接口
            $.getJSON('data/getUserInfo.php?username='+username,function (data) {
                if(data.code == 0){// 请求信息成功
                    $(".loadingWrap").hide();
                    var rsp = data.info;
                    var head_imgSrc = "img/headPhoto/";
                    if(rsp[0].head_img){
                        head_imgSrc += rsp[0].head_img;
                    }
                    rsp[0].username?$(".personInfoWrap").find('li.username .label-content').eq(0).text(rsp[0].username):"";
                    rsp[0].email?$(".personInfoWrap").find('li.email .label-content').eq(0).text(rsp[0].email):"";
                    rsp[0].qq?$(".personInfoWrap").find('li.qq .label-content').eq(0).text(rsp[0].qq):"";

                    rsp[0].time?$(".personInfoWrap").find('li.register_time .label-content').eq(0).text(rsp[0].time):"";
                    rsp[0].login_count?$(".personInfoWrap").find('li.login_count .label-content').eq(0).text(rsp[0].login_count):"";
                    rsp[0].person_info?$(".personInfoWrap").find('li.person_info .label-content').text(rsp[0].person_info):"";

                    //显示用户头像
                    rsp[0].head_img?$(".personInfoWrap").find('.person_img').eq(0).attr('src',head_imgSrc):$(".personInfoWrap").find('.person_img').eq(0).attr('src','');
                }
            });
        }
        $('.headerWrap').load('common.inc/header.html',function () {
            var userInfo;
            if(window.localStorage.getItem('userInfo')){
                userInfo = JSON.parse(window.localStorage.getItem('userInfo'));
            }
            if( userInfo && userInfo.username){
                $('.headerWrap').find('.username').text(userInfo.username);
                $('.headerWrap').find('.login').hide();
                $('.headerWrap').find('.register').hide();
                $('.headerWrap').find(".loginOut").removeClass('hidden');

                //请求信息接口，获取未查看信息条数
                $.get("data/getMessageCount.php?username="+userInfo.username,function (count) {
                    if(count>0){
                        $(".envelope_count").text(count).css({display:"inline-block"});
                    }
                });
                if(localStorage.getItem("menuList")){
                    menuList = JSON.parse(localStorage.getItem("menuList"));
                    $(".wrapItem").removeClass("active");
                    for(var i=0;i<menuList.length;i++){
                        if(menuList[i] == 1){
                            switch (i){
                                case 0://个人信息
                                    getPersonInfo(userInfo.username);
                                    break;
                                case 2://短信查询
                                    showMessage(1);
                                    break;
                                case 3://好友查询
                                    showFriend(1);
                                    break;
                                case 4://花朵查询
                                    showflower(1);
                                    break;
                                case 5://个人相册
                                    break;
                            }
                            $(".wrapItem").eq(i).addClass('active');
                        }
                    }
                }else{
                    menuList = [1,0,0,0,0,0];
                    localStorage.setItem("menuList",JSON.stringify(menuList));
                    getPersonInfo(userInfo.username);
                }

                //消息增加点击事件，跳转到信息查看页面
                $('.envelope_wrap').click(function () {
                    var menuList = [0,0,1,0,0,0];
                    localStorage.setItem("menuList",JSON.stringify(menuList));
                    location.href = 'person_center.html';
                });

            }else{
                //请登录后操作
                //使用unique防止伪登录
                //注册时生成唯一unique,登录时，将unique存在cookie或者session中
                //登录需要对密码进行加密-暂时不做
                //未激活不能登录，激活过的用户，active设置为空，邮箱激活或者手机验证码激活--暂时不做

                //做资料修改的时候，需要进行敏感验证，必须比对cookie和数据库的唯一标识符，防止伪造登录cookie
                //如果做到更安全，在敏感操作后，可以重新生成唯一标识符，并且写入数据库写入cookie
                $("#loginModal").modal('show');
            }
        });
        $('.footerWrap').load('common.inc/footer.html');

        //单击个人信息，请求个人信息接口,添加加载动画,如果之前关闭了浏览器，那么需要重新登录下
        //否则修改的时候会有问题
        $("#personInfo").click(function (e) {
            e.preventDefault();
            menuList = [1,0,0,0,0,0];
            //将menuList保存到本地存储
            localStorage.setItem("menuList",JSON.stringify(menuList));
            $('.wrapItem').removeClass('active');
            $(".wrapItem").eq(0).addClass('active');
            var userInfo;

            if(window.localStorage.getItem('userInfo')){
                userInfo = JSON.parse(window.localStorage.getItem('userInfo'));
            }
            if( userInfo &&  userInfo.username){
                getPersonInfo(userInfo.username);
            }else{
                $("#loginModal").modal('show');
            }
        });
        //修改资料，2 增加验证码验证
        $("#modifyInfo").click(function (e) {
            e.preventDefault();
            menuList = [0,1,0,0,0,0];
            localStorage.setItem("menuList",JSON.stringify(menuList));
            $('.wrapItem').removeClass('active');
            $(".wrapItem").eq(1).addClass('active');
        });

        //单击其他管理下的相应菜单，显示对应内容
        //分页相关函数
        function mlist(list,totalPages,curPage) {
            if(totalPages>=5){  //总页数大于等于5的情况下
                var num = 2;//一个中间分隔数
                //1,2,
                if(curPage>num && curPage<=(totalPages-num) ){ //正常情况下
                    for(var i=num;i>0;i--){
                        var n = curPage-i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                    list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                    //3,4
                    for(var i=1;i<=num;i++){
                        var n = curPage+i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                }else if(curPage<=num){//如果当前页小于$num，也要同时显示5个
                    for(var i=curPage-1;i>0;i--){
                        var n = curPage-i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                    list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                    //3,4
                    for(var i=1;i<=num+(num-curPage+1);i++){//!!! 2-3,1-4
                        var n = curPage+i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                }else if( curPage>totalPages-num ){ //如果当前页大于于$totoalPage，也要同时显示5个
                    for(var i=num+(curPage-totalPages+num);i>0;i--){ //16,17,18||16,17,18,19--19-3,20-4
                        var n = curPage-i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                    list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                    //3,4
                    for(var i=(curPage-totalPages+num);i<num;i++){ //19-1,20-0
                        var n = curPage+i;
                        list += `<li><a href="#" data-page="${n}">${n}</a></li>`;
                    }
                }
            }else{ //总页数小于5时
                for(var i=1;i<curPage;i++){
                    list += `<li><a href="#" data-page="${i}">${i}</a></li>`;
                }
                list += `<li class="nowPage active"><a href="#" data-page="${curPage}">${curPage}</a></li>`;
                for(var i=curPage+1;i<=totalPages;i++){
                    list += `<li><a href="#" data-page="${i}">${i}</a></li>`;
                }

            }
            return list;
        }
        function flist(list, totalPages,curPage) {
            list += `<ul class="pagination">
                             <span class="totalPage" data-total="${totalPages}">共${totalPages}页</span>
                             <span class="curPage">当前第${curPage}页</span>
                             <li>
                             <a href="#" aria-label="first" data-page="1">
                             <span aria-hidden="true">首页</span>
                             </a>
                             </li>
                           <li>
                             <a href="#" aria-label="Previous" class="prev">
                             <span aria-hidden="true">上一页</span>
                             </a>`;
            return list;
        }
        function llist(list,totalPages){
            list += `<li>
                             <a href="#" aria-label="Next" class="next">
                             <span aria-hidden="true">下一页</span>
                             </a>
                             </li>
                             <li>
                             <a href="#" aria-label="end" data-page="${totalPages}">
                             <span aria-hidden="true">尾页</span>
                             </a>
                             </li>`;
            return list;
        }
        function pages(totalPages,curPage) {
            var list = "";
            //首页，上一页
            list = flist(list,totalPages,curPage);
            //中间分页
            list =mlist(list,totalPages,curPage);
            //下一页尾页
            list =llist(list,totalPages);

            return list;
        }
//显示消息
        function showMessage(curPage) {
            $.ajax({
                type:"GET",
                url:"data/getMessage.php?page="+curPage,
                dataType:"JSON",
                async:false,
                success:function (rsp) {
                    if(rsp.code==0){
                        var totalPages = rsp.pagesCount;
                        //显示消息数据
                        //对消息内容长度进行处理
                        var info = rsp.info;
                        for(var i=0;i<info.length;i++){
                            messageArr[i] = info[i].message_content;//i-对应第i行消息
                            if(info[i].message_content.length>20){
                                info[i].message_content = info[i].message_content.substr(0,20)+"...";
                            }
                        }
                        var messageTemp = document.getElementById("messageTemp").innerHTML,
                        html = template(messageTemp,{info:info});
                        $("#showMessageWrap table>tbody").html(html);
                        //生成分页list
                        $("#showMessageWrap .pagelist .Page").html(pages(totalPages,curPage));
                    }else if(rsp.code==2){
                        //重新登录
                        $("#loginModal").modal('show');
                    }else if(rsp.code==-1){
                        $("#showMessageWrap table>tbody").html("");
                    }
                }
            });
        }
//单击消息列表行，显示详细消息内容，并且设置成已查看
        $("#showMessageWrap").on('click','tr',function (e) {
            var index = $(this).index();
            var message_content = messageArr[index];
            notyInfo3(message_content);
            var id = $(this).attr('data-id');
            //设置成已读,需要加一个批量设置已读
            //如果已经是已读状态，就不需要设置了
            var flag = $(this).find(".envelope").hasClass("notWatched");
            var that = this;
            if(flag){
                $.getJSON('data/setMessageRead.php?ids='+id,function (rsp) {
                    if(rsp.code==0){
                        //不需要通知已经设置成已读，只要将消息标示
                        $(that).find(".envelope").removeClass("notWatched");
                        //同时设置头部上的信息数量
                        if(rsp.count>0){
                            $(".envelope_count").text(rsp.count).css({display:"inline-block"});
                        }else{
                            $(".envelope_count").css({display:"none"});
                        }

                    }else if(rsp.code==2){
                        //登录时间过期，请重新登录
                        $("#loginModal").modal('show');
                    }
                });
            }
        });
//显示好友信息
        function showFriend(curPage) {
            $.ajax({
                type:"GET",
                url:"data/getFriend.php?page="+curPage,
                dataType:"JSON",
                async:false,
                success:function (rsp) {
                    if(rsp.code==0){
                        var totalPages = rsp.pagesCount;
                        //对消息内容长度进行处理
                        var info = rsp.info;
                        for(var i=0;i<info.length;i++){
                            friendArr[i] = info[i].friend_content;//i-对应第i行消息
                            if(info[i].friend_content.length>20){
                                info[i].friend_content = info[i].friend_content.substr(0,20)+"...";
                            }
                        }
                        //显示消息数据
                        var friendTemp = document.getElementById("friendTemp").innerHTML,
                            html = template(friendTemp,{info:info});
                        $("#friendWrap table>tbody").html(html);

                        //生成分页list
                        $("#friendWrap .pagelist .Page").html(pages(totalPages,curPage));
                    }else if(rsp.code==2){
                        //重新登录
                        $("#loginModal").modal('show');
                    }else if(rsp.code==-1){
                        $("#friendWrap table>tbody").html("");
                    }
                }
            });
        }
//单击好友行，显示详细好友消息内容，并且设置成已查看
        $("#friendWrap").on('click','tr',function (e) {
            var index = $(this).index();
            var friend_content = friendArr[index];
            //添加是否确认验证按钮

            var id = $(this).attr('data-id');
            //设置成已验证,需要加一个批量设置已读
            //如果已经是已读状态，就不需要设置了
            var flag = $(this).find(".validate").hasClass("notValidate");
            var that = this;
            notyInfo32(friend_content,that,flag,id);

        });
        //显示花朵信息
        function showflower(curPage) {
            $.ajax({
                type:"GET",
                url:"data/getFlower.php?page="+curPage,
                dataType:"JSON",
                async:false,
                success:function (rsp) {
                    if(rsp.code==0){
                        var totalPages = rsp.pagesCount;
                        //对消息内容长度进行处理
                        var info = rsp.info;
                        for(var i=0;i<info.length;i++){
                            flowerArr[i] = info[i].flower_content;//i-对应第i行消息
                            if(info[i].flower_content.length>20){
                                info[i].flower_content = info[i].flower_content.substr(0,20)+"...";
                            }
                        }
                        //显示消息数据
                        var flowerTemp = document.getElementById("flowerTemp").innerHTML,
                            html = template(flowerTemp,{info:info});
                        $("#flowerWrap table>tbody").html(html);
                        //生成分页list
                        $("#flowerWrap .pagelist .Page").html(pages(totalPages,curPage));
                    }else if(rsp.code==2){
                        //重新登录
                        $("#loginModal").modal('show');
                    }else if(rsp.code==-1){
                        $("#flowerWrap table>tbody").html("");
                    }
                }
            });
        }
//单击花朵行，显示详细消息内容
        $("#flowerWrap").on('click','tr',function (e) {
            var index = $(this).index();
            var flower_content = flowerArr[index];
            //添加是否确认验证按钮
            notyInfo(flower_content);

        });

        //其他管理，子菜单
        $(".othersManage").on('click','li.list-group-item>a',function (e) {
            e.preventDefault();
            var $wrapId = $($(this).attr('href')),
                wrapId = $(this).attr('href');

            $(".wrapItem").removeClass('active');
            $wrapId.addClass('active');
            var index = $(this).parent().index();

            menuList = [0,0,0,0,0,0];
            menuList[index+2] = 1;
            //将menuList保存到本地存储
            localStorage.setItem("menuList",JSON.stringify(menuList));
            switch ( wrapId ){
                case "#showMessageWrap":
                    //展示信息
                    showMessage(1);
                    break;
                case "#friendWrap":
                    showFriend(1);
                    break;
                case "#flowerWrap":
                    showflower(1);
                    break;
                case "#personPhotoWrap":
                    break;
            }

        });
//显示相关操作
//使用flag来判断是显示消息还是显示好友，1-消息，2-好友，3-花朵
        function initAction($wrap,flag){
            var $pagelist = $wrap.find(".pagelist").eq(0);
            $pagelist.on('click','li>a:not(.prev,.next)',function (e) {
                e.preventDefault();
                var curPage = parseInt($(this).attr('data-page'));
                if(flag==1){
                    showMessage(curPage);
                }else if(flag==2){
                    showFriend(curPage);
                }
            });
            //上一页，下一页
            $pagelist.on('click','.prev',function (e) {
                e.preventDefault();
                var curPage = parseInt($pagelist.find(".nowPage.active>a").attr("data-page"));
                curPage--;
                if(flag==1){
                    if(curPage>0){
                        showMessage(curPage);
                    }else{
                        showMessage(1);
                    }
                }else if(flag==2){
                    if(curPage>0){
                        showFriend(curPage);
                    }else{
                        showFriend(1);
                    }
                }

            });
            $pagelist.on('click','.next',function (e) {
                e.preventDefault();
                //获取当前页curPage
                var totalPages = $pagelist.find(".totalPage").attr('data-total');
                var curPage = parseInt($pagelist.find(".nowPage.active>a").attr("data-page"));
                curPage++;
                if(flag==1){
                    if(curPage<=totalPages){
                        showMessage(curPage);
                    }else{
                        //获取中页数
                        showMessage(totalPages);
                    }
                }else if(flag==2){
                    if(curPage<=totalPages){
                        showFriend(curPage);
                    }else{
                        //获取中页数
                        showFriend(totalPages);
                    }
                }
            });

            //单击操作复选框,删除单条记录
            $wrap.on('click','input.delete',function (e) {
                e.stopPropagation(); //阻止冒泡
                var that = this;
                if($(this).is(":checked")){
                    //删除记录
                    var id = $(this).attr("data-id");
                    var data = {
                        ids:id,
                        msg:"确认删除该条记录"
                    };
                    if(flag==1){
                        var url = "data/deleteMessage.php?ids="+data.ids;
                        notyInfo22(data,url,flag,that);
                    }else if(flag==2){
                        var url = "data/deleteFriend.php?ids="+data.ids;
                        notyInfo22(data,url,flag,that);
                    }else if(flag==3){
                        var url = "data/deleteFlower.php?ids="+data.ids;
                        notyInfo22(data,url,flag,that);
                    }
                }
            });
            //批量删除
            $wrap.on('click','input.allCheck',function () {
                var checkList = $wrap.find("input.delete");
                var that = this;
                if($(this).is(":checked")){
                    //删除记录
                    var id = "";
                    for(var i=0;i<checkList.length-1;i++){
                        $(checkList[i]).prop("checked",true);
                        id +=  $(checkList[i]).attr('data-id')+",";
                    }
                    $(checkList[i]).prop("checked",true);
                    id +=  $(checkList[i]).attr('data-id');
                    var data = {
                        ids:id,
                        msg:"确认删除该条记录"
                    };
                    if(flag==1){
                        var url = "data/deleteMessage.php?ids="+data.ids;
                        notyInfo2(data,url,flag,that,checkList);
                    }else if(flag==2){
                        var url = "data/deleteFriend.php?ids="+data.ids;
                        notyInfo2(data,url,flag,that,checkList);
                    }else if(flag==3){
                        var url = "data/deleteFlower.php?ids="+data.ids;
                        notyInfo2(data,url,flag,that,checkList);
                    }
                }else{
                    for(var i=0;i<checkList.length;i++){
                        $(checkList[i]).prop("checked",false);
                    }
                }
            });
            //全部标记已读readAll,//全部标记验证好友
            $wrap.on('click','input.allRead',function () {
                var that = this;
                var checkList = $wrap.find("input.delete");
                if($(this).is(":checked")){
                    //删除记录
                    var id = "";
                    for(var i=0;i<checkList.length-1;i++){
                        id +=  $(checkList[i]).attr('data-id')+",";
                    }
                    id +=  $(checkList[i]).attr('data-id');
                    if(flag==1){ //1-message--全部标记已读
                        var count = parseInt($(".envelope_count").text());
                        if(count>0 ){  //前提是还有未读的消息
                            var data = {
                                ids:id,
                                msg:"确认标记全读"
                            };
                            var url = "data/setMessageRead.php?ids="+data.ids;
                            notyInfo4(data,url,flag,that);
                        }
                    }else if(flag==2){ //2-friend--全部标记验证
                        var data = {
                            ids:id,
                            msg:"确认全部通过验证"
                        };
                        var url = "data/setFriendValidate.php?ids="+data.ids;
                        notyInfo4(data,url,flag,that);
                    }


                }else{
                    for(var i=0;i<checkList.length;i++){
                        $(checkList[i]).prop("checked",false);
                    }
                }
            });

        }
//显示消息相关操作
        initAction($("#showMessageWrap"),1);
//显示好友相关操作
        initAction($("#friendWrap"),2);
//显示花朵相关操作
        initAction($("#flowerWrap"),3);
/*--------------------------------修改资料---------------------------------------*/
        //2 增加验证码验证
        $("#modifyinfoForm .yzcodeImg").click(function () {
            this.src= "data/yzCode.php";
        });
        $("#modifyinfoForm").on('blur keyup','input[name=yzcode]',function () {
            var yzcode = $(this).val();
            //验证用户输入的验证码是否和服务器端生成的一样
            if(yzcode != getCookie('yzcode')){
                $(".yzcodeErr").show();
                //提交禁用
                $("#modifyinfoForm").find("button[type=submit]").attr('disabled',true);
                return;
            }else{
                $(".yzcodeErr").hide();
                $("#modifyinfoForm").find("button[type=submit]").attr('disabled',false);
            }
        });
        $("#modifyinfoForm input[name=yzcode]").focus(function () {
            $(".yzcodeErr").hide();
        });

        //提交资料之前，对名字进行处理，名字不能重名
        $(".modifyWrap input[name=username]").on('blur',function () {
            var username = $(this).val();
            $.getJSON('data/isRepeatUsername.php?username='+username,function (rsp) {
                if(rsp.code==0){//用户已存在
                    $(".errcheck_repeat").show();
                    //提交禁用
                    $("#modifyinfoForm").find("button[type=submit]").attr('disabled',true);
                }else{
                    $(".errcheck_repeat").hide();
                    $("#modifyinfoForm").find("button[type=submit]").attr('disabled',false);
                }
            });
        });
        $(".modifyWrap input[name=username]").on('focus',function () {
            $(".errcheck").hide();
        });

        //提交修改的资料,提交先查看cookie中是否uniq,没有重新登录，提交修改资料失败情况处理
        $("#modifyinfoForm").on('submit',function (e) {
            e.preventDefault();
            //验证码不能为空
            var yzcode = $("#modifyinfoForm input[name=yzcode]").val();
            if(yzcode != getCookie('yzcode') || yzcode==''){
                $(".yzcodeErr").show();
                //提交禁用
                $("#modifyinfoForm").find("button[type=submit]").attr('disabled',true);
                return;
            }else{
                $(".yzcodeErr").hide();
                //提交禁用
                $("#modifyinfoForm").find("button[type=submit]").attr('disabled',false);
            }

            var data = $(this).serializeArray();
            var username = data[0].value,
                email = data[1].value,
                qq = data[2].value,
                personInfo = data[3].value;

            //用户名不能为空
            if(username==''){
                $(".errcheck_empty").show();
                return;
            }else{
                $(".errcheck_empty").hide();
            }
            $.ajax({
                type:"POST",
                url:"data/modifyInfo.php",
                dataType:"JSON",
                data:{
                    'username':username,
                    'email':email,
                    'qq':qq,
                    'personInfo':personInfo
                },
                success:function (rsp) {
                    if(rsp.code == 0){  //修改资料成功
                        var userInfo = {
                            username:username,
                            isAutoLogin:1
                        };
                        window.localStorage.setItem('userInfo',JSON.stringify(userInfo)); //1-代表自动登陆
                        $("#modifySuccessModal").modal('show');
                        //当用户关闭模态框，重新加载页面
                        $('#modifySuccessModal').on('hidden.bs.modal', function (e) {
                            window.location.reload();
                        })
                    }else if(rsp.code==-1){  //非法操作
                        $("#modifyFailModal").modal('show');
                    }else if(rsp.code == 1){  //重新登录，原因是关闭过浏览器，使用session保存的用户名和uniq已经失效
                        $("#loginModal").modal('show');
                    }
                }
            });
        });

        //每次刷新,从本地存储中取上次所在的导航页，而不是每次都是个人信息页
    })();

</script>
<!--------------------------------上传头像--------------------------------------->
<script type="text/javascript">
    $(function(){
        // 初始化插件
        $("#zyupload").zyUpload({
            width            :   "100%",                 // 宽度
            height           :   "400px",                 // 宽度
            itemWidth        :   "100px",                 // 文件项的宽度
            itemHeight       :   "80px",                 // 文件项的高度
            url              :   "data/up.php",              // 上传文件的路径
            fileType         :   ["jpg","png","jpeg","gif","bmp"],// 上传文件的类型
            fileSize         :   51200,                // 头像的大小5KB
            multiple         :   false,                    // 是否可以多个文件上传
            dragDrop         :   false,                   // 是否可以拖动上传文件
            tailor           :   false,                   // 是否可以裁剪图片
            del              :   true,                    // 是否可以删除文件
            finishDel        :   false,  				  // 是否在上传文件完成后删除预览
            /* 外部获得的回调接口 */
            onSuccess: function(file, rsp){          // 文件上传成功的回调方法
                var rsp = JSON.parse(rsp);
                if( rsp.code == 0 ){
                    $("#uploadInf").html("<p class='text-success'>"+rsp.msg+"</p>");
                }else if( rsp.code == 1 ){
                    $("#uploadInf").html("<p class='text-success'>"+rsp.msg+"</p>");
                }else if( rsp.code == -1 ){
                    $("#uploadInf").html("<p class='text-success'>"+rsp.msg+"</p>");
                }
            },
            onFailure: function(file, response){          // 文件上传失败的回调方法
                $("#uploadInf").html("<p class='text-danger'>上传失败</p>");
            }
        });

    });

</script>
</html>
